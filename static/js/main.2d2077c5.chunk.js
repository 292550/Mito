(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{48:function(e,t,n){e.exports=n(78)},54:function(e,t,n){},71:function(e,t,n){},78:function(e,t,n){"use strict";n.r(t);var i=n(0),r=n.n(i),a=n(38),o=n.n(a),s=(n(54),n(2)),l=n(3),u=n(6),c=n(4),h=n(5),d=n(46),p=n(39),v=n(15),f=n(18),m=n.n(f),y=n(1),g={click:!0,contextmenu:!0,dblclick:!0,mousedown:!0,mouseup:!0,mousemove:!0,touchstart:!0,touchmove:!0,touchend:!0,keyup:!0,keydown:!0,keypress:!0,wheel:!0},w=function(){function e(t,n){Object(s.a)(this,e),this.renderer=t,this.audioContext=n,this.elements=void 0,this.events=void 0,this.timeElapsed=0,this.frameCount=0}return Object(l.a)(e,[{key:"aspectRatio",get:function(){return this.renderer.domElement.height/this.renderer.domElement.width}},{key:"resolution",get:function(){return new y.D(this.renderer.domElement.width,this.renderer.domElement.height)}},{key:"canvas",get:function(){return this.renderer.domElement}}]),e}();w.id=void 0;var b,k,j,O,x,E,A,S=n(35),M=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this,e))).frameId=void 0,n.lastTimestamp=0,n.loop=function(e){var t=e-n.lastTimestamp;n.lastTimestamp=e,n.props.sketch.frameCount++,n.props.sketch.timeElapsed=e;try{n.props.sketch.animate(t)}catch(i){console.error(i)}n.setState({frameCount:n.props.sketch.frameCount}),n.frameId=requestAnimationFrame(n.loop)},n.handleWindowResize=function(){var e=n.props.sketch.renderer;n.updateRendererCanvasToMatchParent(e),null!=n.props.sketch.resize&&n.props.sketch.resize(e.domElement.width,e.domElement.height)},n.state={frameCount:e.sketch.frameCount},n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.updateRendererCanvasToMatchParent(this.props.sketch.renderer),window.addEventListener("resize",this.handleWindowResize);var t=this.props.sketch.renderer.domElement;t.tabIndex=1,Object.keys(g).forEach(function(n){if(null!=e.props.sketch.events){var i=e.props.sketch.events[n];null!=i&&(e.props.eventsOnBody?document.body.addEventListener(n,i):t.addEventListener(n,i))}}),this.frameId=requestAnimationFrame(this.loop)}},{key:"render",value:function(){var e=[];return null!=this.props.sketch.render&&e.push(this.props.sketch.render()),null!=this.props.sketch.elements&&e.push.apply(e,Object(v.a)(this.props.sketch.elements)),i.createElement("div",{className:"sketch-elements"},e.map(function(e,t){return i.cloneElement(e,{key:t})}))}},{key:"componentWillUnmount",value:function(){var e=this;this.props.sketch.destroy&&this.props.sketch.destroy(),null!=this.frameId&&cancelAnimationFrame(this.frameId),this.props.sketch.renderer.dispose(),window.removeEventListener("resize",this.handleWindowResize);var t=this.props.sketch.canvas;Object.keys(g).forEach(function(n){if(null!=e.props.sketch.events){var i=e.props.sketch.events[n];null!=i&&(e.props.eventsOnBody?document.body.removeEventListener(n,i):t.removeEventListener(n,i))}})}},{key:"updateRendererCanvasToMatchParent",value:function(e){var t=e.domElement.parentElement;null!=t&&e.setSize(t.clientWidth,t.clientHeight)}}]),t}(i.Component),C=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).state={status:{type:"loading"},volumeEnabled:JSON.parse(window.localStorage.getItem("sketch-volumeEnabled")||"true")},n.audioContext=void 0,n.userVolume=void 0,n.handleContainerRef=function(e){if(null!=e)try{var t=window.AudioContext||window.webkitAudioContext,i=n.audioContext=new t;y.c.setContext(i),n.userVolume=i.createGain(),n.userVolume.gain.setValueAtTime(.8,0),n.userVolume.connect(i.destination),(i.gain=i.createGain()).connect(n.userVolume),document.addEventListener("visibilitychange",n.handleVisibilityChange);var r=new y.F({alpha:!0,preserveDrawingBuffer:!0,antialias:!0});e.appendChild(r.domElement);var a=n.props.otherArgs||[],o=Object(p.a)(n.props.sketchClass,[r,n.audioContext].concat(Object(v.a)(a)));n.setState({status:{type:"success",sketch:o}})}catch(s){n.setState({status:{type:"error",error:s}}),console.error(s)}else document.removeEventListener("visibilitychange",n.handleVisibilityChange),null!=n.audioContext&&n.audioContext.close()},n.handleVolumeButtonClick=function(){var e=!n.state.volumeEnabled;n.setState({volumeEnabled:e}),window.localStorage.setItem("sketch-volumeEnabled",JSON.stringify(e))},n.handleVisibilityChange=function(){null!=n.audioContext&&(document.hidden?n.audioContext.suspend():n.state.volumeEnabled&&n.audioContext.resume())},n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){null!=this.userVolume&&null!=this.audioContext&&(this.state.volumeEnabled&&"suspended"===this.audioContext.state?this.audioContext.resume():this.state.volumeEnabled||"running"!==this.audioContext.state||this.audioContext.suspend());var e=this.props,t=(e.sketchClass,Object(d.a)(e,["sketchClass"])),n=m()("sketch-component",this.state.status.type);return i.createElement("div",Object.assign({},t,{id:this.props.sketchClass.id,className:n,ref:this.handleContainerRef}),this.renderSketchOrStatus(),this.renderVolumeButton())}},{key:"renderSketchOrStatus",value:function(){var e=this.state.status;return"success"===e.type?i.createElement(M,{key:this.props.sketchClass.id,sketch:e.sketch,eventsOnBody:this.props.eventsOnBody}):"error"===e.type?this.props.errorElement||this.renderDefaultErrorElement(e.error.message):"loading"===e.type?null:void 0}},{key:"renderDefaultErrorElement",value:function(e){return i.createElement("p",{className:"sketch-error"},"Oops - something went wrong! Make sure you're using Chrome, or are on your desktop.",i.createElement("pre",null,e))}},{key:"renderVolumeButton",value:function(){var e=this.state.volumeEnabled;return i.createElement("button",{className:"user-volume",onClick:this.handleVolumeButtonClick},e?i.createElement(S.b,null):i.createElement(S.a,null))}}]),t}(i.Component),T=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).handleDivRef=function(e){null!=e||n.exitFullscreen()},n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return i.createElement("div",{className:"full-page-sketch",ref:this.handleDivRef},i.createElement(C,{sketchClass:this.props.sketchClass,otherArgs:this.props.otherArgs}))}},{key:"exitFullscreen",value:function(){document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen()}}]),t}(i.Component),R=n(8);function P(e,t,n){e.x=e.x*(1-n)+t.x*n,e.y=e.y*(1-n)+t.y*n}function D(e,t,n,i,r){return function(e,t,n){return e+(t-e)*n}(i,r,(e-t)/(n-t))}function N(e,t){var n=document.createElement("source");return n.src="/assets/audio/".concat(e,".").concat(t),n.type="audio/".concat(t),n}function F(e,t){var n=document.createElement("audio");n.autoplay=!0,n.loop=!0,n.appendChild(N(t,"ogg")),n.appendChild(N(t,"mp3")),n.appendChild(N(t,"wav"));var i=e.createMediaElementSource(n),r=e.createGain();return i.connect(r),{audio:n,gain:r}}var W=n(40),B=n(25);function L(e){return Math.round(1e12*e)/1e12}var I=function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;Object(s.a)(this,e),this.capacity=t,this.carrier=n,this.water=i,this.sugar=r,this.events=void 0,this.validate()}return Object(l.a)(e,[{key:"give",value:function(e,t,n){if(e===this)throw new Error("shouldn't give to self");var i=Math.min(t,this.water),r=Math.min(n,this.sugar),a=L(i+r),o=e.space();return a>o&&(i=Math.floor(i/a*o),r=Math.floor(r/a*o)),this.change(-i,-r),e.change(i,r),this.events&&this.events.emit("give",e,i,r),e.events&&e.events.emit("get",this,i,r),{water:i,sugar:r}}},{key:"on",value:function(e,t){this.events=this.events||new B.EventEmitter,this.events.on(e,t)}},{key:"add",value:function(e,t){var n=L(e+t),i=this.space();n>i&&(e=e/n*i,t=t/n*i),this.change(e,t)}},{key:"change",value:function(e,t){var n=L(this.water+e),i=L(this.sugar+t);this.validate(n,i),this.water=n,this.sugar=i,this.water<0&&(this.water=0),this.sugar<0&&(this.sugar=0),this.water+this.sugar>this.capacity&&(this.water>this.sugar?this.water=this.capacity-this.sugar:this.sugar=this.capacity-this.water)}},{key:"space",value:function(){return L(this.capacity-this.water-this.sugar)}},{key:"validate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.water,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.sugar,n=this.capacity;e<0&&console.warn("water < 0: ".concat(e)),t<0&&console.warn("sugar < 0: ".concat(t)),e+t>n&&console.warn("bad inventory: ".concat(e," water + ").concat(t," > ").concat(n," max"))}}]),e}();function z(e){return null!=e&&e.inventory instanceof I}var Y=n(10),U={isRealtime:!0,environment:"Temperate",cellEnergyMax:1e4,tissueInventoryCapacity:6,rootTurnsPerTransfer:20,leafReactionRate:.01,leafSugarPerReaction:1,cellGestationTurns:0,cellDiffusionWater:.002,cellDiffusionSugar:.002,soilDarknessBase:.2,soilDiffusionType:"discrete",soilDiffusionWater:.001,veinDiffusion:.5,soilMaxWater:20,droop:.03,fountainTurnsPerWater:11,fountainAppearanceRate:1.5,transportTurnsPerMove:5,sunlightReintroduction:.15,sunlightDiffusion:0,maxResources:100},q=Object(Y.a)({},U);if(window.location.hash.length>0){var V=JSON.parse(decodeURI(window.location.hash.substr(1)));Object.assign(q,V)}function G(){for(var e={},t=0,n=Object.keys(U);t<n.length;t++){var i=n[t],r=q[i];r!==U[i]&&(e[i]=r)}Object.keys(e).length>0?window.location.hash=encodeURI(JSON.stringify(e)):window.location.hash=""}G();var _=n(11),K=n(7),H=function(){function e(t,n,i){Object(s.a)(this,e),this.x=t,this.y=n,this.z=i}return Object(l.a)(e,[{key:"dot2",value:function(e,t){return this.x*e+this.y*t}},{key:"dot3",value:function(e,t,n){return this.x*e+this.y*t+this.z*n}}]),e}(),X=[new H(1,1,0),new H(-1,1,0),new H(1,-1,0),new H(-1,-1,0),new H(1,0,1),new H(-1,0,1),new H(1,0,-1),new H(-1,0,-1),new H(0,1,1),new H(0,-1,1),new H(0,1,-1),new H(0,-1,-1)],J=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],Z=.5*(Math.sqrt(3)-1),Q=(3-Math.sqrt(3))/6,$=1/6,ee=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2147483647*Math.random();Object(s.a)(this,e),this.perm=new Array(512),this.gradP=new Array(512),this.octaveNum=6,this.octaveFalloff=.5,this.octaveMatrix2=[2*Math.cos(1),2*-Math.sin(1),2*Math.sin(1),2*Math.cos(1)],this.seed(t)}return Object(l.a)(e,[{key:"seed",value:function(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(var t=0;t<256;t++){var n=void 0;n=1&t?J[t]^255&e:J[t]^e>>8&255,this.perm[t]=this.perm[t+256]=n,this.gradP[t]=this.gradP[t+256]=X[n%12]}}}]),Object(l.a)(e,[{key:"simplex2",value:function(e,t){var n,i,r=(e+t)*Z,a=Math.floor(e+r),o=Math.floor(t+r),s=(a+o)*Q,l=e-a+s,u=t-o+s;l>u?(n=1,i=0):(n=0,i=1);var c=l-n+Q,h=u-i+Q,d=l-1+2*Q,p=u-1+2*Q;a&=255,o&=255;var v=this.gradP[a+this.perm[o]],f=this.gradP[a+n+this.perm[o+i]],m=this.gradP[a+1+this.perm[o+1]],y=.5-l*l-u*u,g=.5-c*c-h*h,w=.5-d*d-p*p;return 70*((y<0?0:(y*=y)*y*v.dot2(l,u))+(g<0?0:(g*=g)*g*f.dot2(c,h))+(w<0?0:(w*=w)*w*m.dot2(d,p)))}},{key:"octaveSimplex2",value:function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.octaveNum,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.octaveFalloff,r=0,a=e,o=t,s=1,l=0;l<n;l++){r+=this.simplex2(a,o)*s;var u=a*this.octaveMatrix2[0]+o*this.octaveMatrix2[1],c=a*this.octaveMatrix2[2]+o*this.octaveMatrix2[3];a=u,o=c,s*=i}return r}},{key:"simplex3",value:function(e,t,n){var i,r,a,o,s,l,u=(e+t+n)*(1/3),c=Math.floor(e+u),h=Math.floor(t+u),d=Math.floor(n+u),p=(c+h+d)*$,v=e-c+p,f=t-h+p,m=n-d+p;v>=f?f>=m?(i=1,r=0,a=0,o=1,s=1,l=0):v>=m?(i=1,r=0,a=0,o=1,s=0,l=1):(i=0,r=0,a=1,o=1,s=0,l=1):f<m?(i=0,r=0,a=1,o=0,s=1,l=1):v<m?(i=0,r=1,a=0,o=0,s=1,l=1):(i=0,r=1,a=0,o=1,s=1,l=0);var y=v-i+$,g=f-r+$,w=m-a+$,b=v-o+2*$,k=f-s+2*$,j=m-l+2*$,O=v-1+.5,x=f-1+.5,E=m-1+.5;c&=255,h&=255,d&=255;var A=this.gradP,S=this.perm,M=A[c+S[h+S[d]]],C=A[c+i+S[h+r+S[d+a]]],T=A[c+o+S[h+s+S[d+l]]],R=A[c+1+S[h+1+S[d+1]]],P=.6-v*v-f*f-m*m,D=.6-y*y-g*g-w*w,N=.6-b*b-k*k-j*j,F=.6-O*O-x*x-E*E;return 32*((P<0?0:(P*=P)*P*M.dot3(v,f,m))+(D<0?0:(D*=D)*D*C.dot3(y,g,w))+(N<0?0:(N*=N)*N*T.dot3(b,k,j))+(F<0?0:(F*=F)*F*R.dot3(O,x,E)))}},{key:"octaveSimplex3",value:function(e,t,n){for(var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.octaveNum,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.octaveFalloff,a=0,o=e,s=t,l=n,u=1,c=0;c<i;c++)a+=this.simplex3(o,s,l)*u,o*=2,s*=2,l*=2,u*=r;return a}},{key:"fade",value:function(e){return e*e*e*(e*(6*e-15)+10)}},{key:"lerp",value:function(e,t,n){return(1-n)*e+n*t}},{key:"perlin2",value:function(e,t){var n=Math.floor(e),i=Math.floor(t);e-=n,t-=i,n&=255,i&=255;var r=this.gradP,a=this.perm,o=r[n+a[i]].dot2(e,t),s=r[n+a[i+1]].dot2(e,t-1),l=r[n+1+a[i]].dot2(e-1,t),u=r[n+1+a[i+1]].dot2(e-1,t-1),c=this.fade(e);return this.lerp(this.lerp(o,l,c),this.lerp(s,u,c),this.fade(t))}},{key:"perlin3",value:function(e,t,n){var i=this.gradP,r=this.perm,a=Math.floor(e),o=Math.floor(t),s=Math.floor(n);e-=a,t-=o,n-=s;var l=i[(a&=255)+r[(o&=255)+r[s&=255]]].dot3(e,t,n),u=i[a+r[o+r[s+1]]].dot3(e,t,n-1),c=i[a+r[o+1+r[s]]].dot3(e,t-1,n),h=i[a+r[o+1+r[s+1]]].dot3(e,t-1,n-1),d=i[a+1+r[o+r[s]]].dot3(e-1,t,n),p=i[a+1+r[o+r[s+1]]].dot3(e-1,t,n-1),v=i[a+1+r[o+1+r[s]]].dot3(e-1,t-1,n),f=i[a+1+r[o+1+r[s+1]]].dot3(e-1,t-1,n-1),m=this.fade(e),y=this.fade(t),g=this.fade(n);return this.lerp(this.lerp(this.lerp(l,d,m),this.lerp(u,p,m),g),this.lerp(this.lerp(c,v,m),this.lerp(h,f,m),g),y)}}]),e}(),te={nw:new y.D(-1,-1),w:new y.D(-1,0),sw:new y.D(-1,1),n:new y.D(0,-1),s:new y.D(0,1),ne:new y.D(1,-1),e:new y.D(1,0),se:new y.D(1,1)},ne=Object.keys(te).map(function(e){return te[e]});function ie(e){return"number"===typeof e.energy}var re=function(){function e(t,n){if(Object(s.a)(this,e),this.world=n,this.isObstacle=!1,this.darkness=1/0,this.pos=void 0,this.pos=t.clone(),null==n)throw new Error("null world!")}return Object(l.a)(e,[{key:"diffusionWater",get:function(){return this.constructor.diffusionWater}},{key:"diffusionSugar",get:function(){return this.constructor.diffusionSugar}},{key:"fallAmount",get:function(){return this.constructor.fallAmount}}]),Object(l.a)(e,[{key:"lightAmount",value:function(){return Math.sqrt(Math.min(Math.max(D(1-this.darkness,0,1,0,1),0),1))}},{key:"step",value:function(){if(this.world.time%3===0){var e=this.world.tileNeighbors(this.pos);this.stepDarkness(e),this.stepDiffusion(e),this.stepGravity()}}},{key:"stepDarkness",value:function(e){if(this instanceof de)this.darkness=0;else{var t=this.darkness,n=!0,i=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value,l=Object(K.a)(s,2)[1],u=Math.max(.2,D(this.pos.y,this.world.height/2,this.world.height,q.soilDarknessBase,1)),c=l instanceof ue?1/0:l.darkness+u;t=l instanceof de?0:Math.min(t,c)}}catch(d){i=!0,r=d}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}this.darkness=t;var h=null!=this.world.cellAt(this.pos.x,this.pos.y);h&&console.error("stepping environmental tile even when a cell is on-top:",h)}}},{key:"stepDiffusion",value:function(e){if(z(this)){var t=!0,n=!1,i=void 0;try{for(var r,a=e[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value,s=Object(K.a)(o,2),l=s[0],u=s[1];this.canDiffuse(l,u)&&(null!=this.diffusionWater&&u.inventory.water>this.inventory.water&&this.diffuseWater(u),null!=this.diffusionSugar&&u.inventory.sugar>this.inventory.sugar&&this.diffuseSugar(u))}}catch(c){n=!0,i=c}finally{try{t||null==a.return||a.return()}finally{if(n)throw i}}}}},{key:"canDiffuse",value:function(e,t){return ae(this,t)}},{key:"diffuseWater",value:function(e){if(z(this))if("continuous"===q.soilDiffusionType){var t=(e.inventory.water-this.inventory.water)*this.diffusionWater;e.inventory.give(this.inventory,t,0)}else{var n=e.inventory.water-this.inventory.water,i=Math.min(n,1);Math.random()<n*this.diffusionWater*i&&e.inventory.give(this.inventory,1,0)}}},{key:"diffuseSugar",value:function(e){if(z(this)){var t=(e.inventory.sugar-this.inventory.sugar)*this.diffusionSugar;e.inventory.give(this.inventory,0,t)}}},{key:"stepGravity",value:function(){var e=this.fallAmount,t=this.world.tileAt(this.pos.x,this.pos.y+1);e>0&&this.world.time%Math.floor(1/e)<1&&z(t)&&ae(t,this)&&this.inventory.give(t.inventory,1,0)}}]),e}();function ae(e,t){return z(e)&&z(t)&&(e instanceof t.constructor||t instanceof e.constructor||e instanceof de&&t instanceof de||function(e,t,n,i){return e instanceof t&&n instanceof i}(e,le,t,se))}re.displayName="Tile",re.fallAmount=0;var oe=new ee,se=function(e){function t(e,n){var i;return Object(s.a)(this,t),(i=Object(u.a)(this,Object(c.a)(t).call(this,e,n))).pos=e,i.sunlightCached=1,i._co2=void 0,i.inventory=new I(20,Object(R.a)(i)),i.darkness=0,i._co2=i.computeCo2(),i}return Object(h.a)(t,e),Object(l.a)(t,[{key:"computeCo2",value:function(){var e=D(this.pos.y,this.world.height/2,0,this.world.environment.floorCo2,1.15),t=D(this.pos.y,this.world.height/2,0,4,9),n=null==this.world?0:this.world.time,i=.25*oe.perlin3(94.231+(this.pos.x-this.world.width/2)/t,2312+this.pos.y/8,n/1e3+93.1);return Math.max(Math.min(e+i,1),Math.min(.4,.75*this.world.environment.floorCo2))}},{key:"lightAmount",value:function(){return this.sunlight()}},{key:"step",value:function(){this.world.time%3===0&&(this.stepGravity(),this.stepDiffusion(this.world.tileNeighbors(this.pos)),this.stepEvaporation(),this._co2=this.computeCo2())}},{key:"stepEvaporation",value:function(){Math.random()<.01*this.inventory.water&&this.inventory.add(-1,0)}},{key:"canDiffuse",value:function(e,n){return e!==te.s&&e!==te.sw&&e!==te.se&&Object(_.a)(Object(c.a)(t.prototype),"canDiffuse",this).call(this,e,n)}},{key:"co2",value:function(){return this._co2}},{key:"sunlight",value:function(){return this.sunlightCached}}]),t}(re);se.displayName="Air",se.fallAmount=1,se.diffusionWater=.1;var le=function(e){function t(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this,e,r))).inventory=new I(q.soilMaxWater,Object(R.a)(n)),n.inventory.add(i,0),n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"fallAmount",get:function(){return this.world.environment.waterGravityPerTurn}}]),Object(l.a)(t,[{key:"step",value:function(){this.world.time%3===0&&(Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this),this.stepEvaporation())}},{key:"stepEvaporation",value:function(){var e=this.world.environment,t=e.evaporationRate,n=e.evaporationBottom,i=D(this.pos.y,this.world.height/2,this.world.height*n,1,0),r=this.inventory.water;Math.random()<t*i*r&&this.inventory.add(-1,0)}}]),t}(re);le.displayName="Soil",le.diffusionWater=q.soilDiffusionWater;var ue=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).isObstacle=!0,n}return Object(h.a)(t,e),t}(re);ue.displayName="Rock";var ce=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(c.a)(t).apply(this,arguments))}return Object(h.a)(t,e),t}(re);ce.displayName="Dead Cell";var he=function(e){function t(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this,e,i,r))).turnsPerWater=a,n.isObstacle=!0,n.cooldown=0,n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"step",value:function(){this.world.time%3===0&&(Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this),this.cooldown>0&&this.cooldown--,this.inventory.space()>1&&this.cooldown<=0&&(this.inventory.add(1,0),this.cooldown=this.turnsPerWater))}}]),t}(le);he.displayName="Fountain";var de=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).energy=q.cellEnergyMax,n.darkness=0,n.droopY=0,n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"step",value:function(){if(this.world.time%3===0){Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this),this.energy-=1;var e=this.world.tileNeighbors(this.pos),n=Array.from(e.values()),i=[].concat(Object(v.a)(n),[this]),r=!0,a=!1,o=void 0;try{for(var s,l=i[Symbol.iterator]();!(r=(s=l.next()).done);r=!0){var u=s.value;if(z(u)&&!(u instanceof ye)){if(!(this.energy<q.cellEnergyMax))break;var h=q.cellEnergyMax-this.energy,d=Math.min(h/q.cellEnergyMax,u.inventory.sugar);u.inventory.add(0,-d);var p=d*q.cellEnergyMax;this.energy+=p}}}catch(O){a=!0,o=O}finally{try{r||null==l.return||l.return()}finally{if(a)throw o}}if(this.energy<q.cellEnergyMax){var f=i.filter(function(e){return ie(e)}),m=!0,y=!1,g=void 0;try{for(var w,b=f[Symbol.iterator]();!(m=(w=b.next()).done);m=!0){var k=w.value;if(!(this.energy<q.cellEnergyMax))break;var j=0;if(k.energy>this.energy){if(j=Math.floor(.25*(k.energy-this.energy)),k.energy-j<0)throw new Error("cell energy diffusion: taking more energy than available");if(this.energy+j>q.cellEnergyMax)throw new Error("cell energy diffusion: taking more energy than i can carry");this.energy+=j,k.energy-=j}}}catch(O){y=!0,g=O}finally{try{m||null==b.return||b.return()}finally{if(y)throw g}}}this.stepDroop(e),this.droopY>.5&&(this.world.player.pos.equals(this.pos)&&(this.world.player.pos.y+=1),this.world.maybeRemoveCellAt(this.pos),this.pos.y<this.world.height-1&&(this.pos.y+=1),this.droopY-=1,this.world.setTileAt(this.pos,this)),this.energy<=0&&this.world.setTileAt(this.pos,new ce(this.pos,this.world))}}},{key:"stepDroop",value:function(e){var n=e.get(te.s),i=e.get(te.sw),r=e.get(te.se),a=e.get(te.w),o=e.get(te.e),s=e.get(te.n),l=e.get(te.nw),u=e.get(te.ne);this.droopY+=q.droop,this.energy<q.cellEnergyMax/2&&(this.droopY+=q.droop);for(var c=!1,h=0,d=[n,i,r];h<d.length;h++){var p=d[h];if(p instanceof ue||p instanceof le)return void(this.droopY=Math.min(this.droopY,0));if(p instanceof t)return this.droopY=Math.min(this.droopY,p.droopY),void(c=!0)}var v=[l,s,u,a,o,this].filter(function(e){return e instanceof t});c||1!==v.length?this.droopY=v.reduce(function(e,t){return e+t.droopY},0)/v.length:this.droopY+=1}}]),t}(re);de.displayName="Cell",de.diffusionWater=q.cellDiffusionWater,de.diffusionSugar=q.cellDiffusionSugar,de.turnsToBuild=q.cellGestationTurns;var pe=function(e){function t(e,n,i){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(c.a)(t).call(this,e,n))).completedCell=i,r.isObstacle=!0,r.timeRemaining=void 0,r.timeToBuild=void 0,r.timeRemaining=r.timeToBuild=i.constructor.turnsToBuild||0,r}return Object(h.a)(t,e),Object(l.a)(t,[{key:"step",value:function(){this.world.time%3===0&&(Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this),this.timeRemaining--,this.timeRemaining<=0&&this.world.setTileAt(this.completedCell.pos,this.completedCell))}}]),t}(de),ve=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).inventory=new I(q.tissueInventoryCapacity,Object(R.a)(n)),n}return Object(h.a)(t,e),t}(de);ve.displayName="Tissue";var fe=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).isObstacle=!0,n.averageEfficiency=0,n.averageSpeed=0,n.didConvert=!1,n.sugarConverted=0,n.tilePairs=[],n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"step",value:function(){if(this.world.time%3===0){Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this),this.didConvert=!1;var e=this.world.tileNeighbors(this.pos);this.averageEfficiency=0,this.averageSpeed=0,this.sugarConverted=0;var n=0;this.tilePairs=[];var i=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value,u=Object(K.a)(l,2),h=u[0],d=u[1],p=this.world.tileAt(this.pos.x-h.x,this.pos.y-h.y);if(d instanceof se&&p instanceof ve){n+=1,this.tilePairs.push(h);var v=d,f=p,m=v.sunlight(),y=v.co2();this.averageEfficiency+=y,this.averageSpeed+=m;var g=q.leafSugarPerReaction/y,w=Math.min(f.inventory.water,g),b=m*q.leafReactionRate*w/g;if(Math.random()<b){this.didConvert=!0;var k=w*y;f.inventory.add(-w,k),this.sugarConverted+=k}}}}catch(j){r=!0,a=j}finally{try{i||null==s.return||s.return()}finally{if(r)throw a}}n>0&&(this.averageEfficiency/=n)}}}]),t}(de);fe.displayName="Leaf";var me=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).waterTransferAmount=0,n.activeNeighbors=[],n.inventory=new I(q.tissueInventoryCapacity,Object(R.a)(n)),n.cooldown=0,n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"step",value:function(){this.world.time%3===0&&(Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this),this.cooldown<=0&&(this.stepWaterTransfer(),this.cooldown+=q.rootTurnsPerTransfer),this.cooldown-=1)}},{key:"stepWaterTransfer",value:function(){this.waterTransferAmount=0,this.activeNeighbors=[];var e=this.world.tileNeighbors(this.pos),t=!0,n=!1,i=void 0;try{for(var r,a=e[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value,s=Object(K.a)(o,2),l=s[0],u=s[1];if(u instanceof le){this.activeNeighbors.push(l);var c=u.inventory.give(this.inventory,1,0).water;this.waterTransferAmount+=c+1e-4*Math.random()}}}catch(h){n=!0,i=h}finally{try{t||null==a.return||a.return()}finally{if(n)throw i}}}}]),t}(de);me.displayName="Root";var ye=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).isObstacle=!0,n.inventory=new I(t.sugarToWin+100,Object(R.a)(n)),n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"step",value:function(){if(this.world.time%3===0){Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this);var e=this.world.tileNeighbors(this.pos),n=!0,i=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value,l=Object(K.a)(s,2)[1];z(l)&&l.inventory.give(this.inventory,0,l.inventory.sugar)}}catch(u){i=!0,r=u}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}}}]),t}(de);ye.displayName="Fruit",ye.sugarToWin=200;var ge=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).dir=void 0,n.cooldown=0,n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"step",value:function(){if(this.world.time%3===0){if(this.energy-=1,Object(_.a)(Object(c.a)(t.prototype),"step",this).call(this),this.cooldown<=0){this.cooldown+=q.transportTurnsPerMove;var e=this.getTarget();e&&this.inventory.give(e.inventory,1,1);var n=this.getFrom();n&&n.inventory.give(this.inventory,1,1)}this.cooldown-=1}}},{key:"getTarget",value:function(){var e=this.world.tileAt(this.pos.x+this.dir.x,this.pos.y+this.dir.y);if(e instanceof de&&z(e))return e}},{key:"getFrom",value:function(){var e=this.world.tileAt(this.pos.x-this.dir.x,this.pos.y-this.dir.y);if(e instanceof de&&z(e))return e}}]),t}(ve);ge.displayName="Transport";var we=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).inventory=new I(8,Object(R.a)(n)),n}return Object(h.a)(t,e),Object(l.a)(t,null,[{key:"diffusionWater",get:function(){return q.veinDiffusion}},{key:"diffusionSugar",get:function(){return q.veinDiffusion}}]),t}(ve);we.displayName="Vein";var be={j:{type:"drop",sugar:0,water:.25},k:{type:"drop",sugar:.25,water:0},".":{type:"still"}},ke={w:{type:"move",dir:te.n},a:{type:"move",dir:te.w},s:{type:"move",dir:te.s},d:{type:"move",dir:te.e},q:{type:"move",dir:te.nw},e:{type:"move",dir:te.ne},z:{type:"move",dir:te.sw},c:{type:"move",dir:te.se}},je=Object.keys(ke).map(function(e){return ke[e]}),Oe={u:ve,l:fe,o:me,p:ge,i:ye},xe=function(){function e(t,n){Object(s.a)(this,e),this.posFloat=t,this.world=n,this.inventory=new I(q.maxResources,this,Math.round(q.maxResources/3),Math.round(q.maxResources/3)),this.action=void 0,this.events=new B.EventEmitter,this.actionQueue=[],this.mapActions=void 0,this.speed=.15,this.suckWater=!0,this.suckSugar=!0}return Object(l.a)(e,[{key:"pos",get:function(){return this.posFloat.clone().round()}}]),Object(l.a)(e,[{key:"setActions",value:function(e){this.actionQueue=e}},{key:"setAction",value:function(e){this.action=e,this.actionQueue=[]}},{key:"getAction",value:function(){return this.action}},{key:"droopY",value:function(){var e=this.world.tileAt(this.pos.x,this.pos.y);return e instanceof de?e.droopY:0}},{key:"droopPosFloat",value:function(){var e=this.droopY();if(0!==e){var t=this.posFloat.clone();return t.y+=e,t}return this.posFloat}},{key:"currentTile",value:function(){return this.world.tileAt(this.pos)}},{key:"on",value:function(e,t){this.events.on(e,t)}},{key:"step",value:function(){if(void 0===this.action&&(this.action=this.actionQueue.shift()||{type:"none"}),this.mapActions){var e=this.mapActions(this,this.action);if(Array.isArray(e)){var t,n=Object(W.a)(e),i=n[0],r=n.slice(1);this.action=i,(t=this.actionQueue).unshift.apply(t,Object(v.a)(r))}else this.action=null!=e?e:{type:"none"}}var a=this.attemptAction(this.action);this.suckWater||this.attemptAction(be.j),this.suckSugar||this.attemptAction(be.k),a&&this.events.emit("action",this.action),this.action=void 0}},{key:"attemptAction",value:function(e){switch(e.type){case"none":return!0;case"still":return this.attemptStill();case"move":return this.attemptMove(e);case"build":return this.attemptBuild(e);case"build-transport":return this.attemptBuildTransport(e);case"deconstruct":return this.attemptDeconstruct(e);case"drop":return this.attemptDrop(e);case"multiple":return this.attemptMultiple(e)}}},{key:"verifyMove",value:function(e){var t=this.posFloat.clone().add(e.dir.clone().setLength(this.speed)).round();return this.isWalkable(t)}},{key:"isWalkable",value:function(e){if(e instanceof re&&(e=e.pos),!this.world.isValidPosition(e.x,e.y))return!1;var t=this.world.tileAt(e.x,e.y);return t instanceof de&&null!=t&&!t.isObstacle}},{key:"isBuildCandidate",value:function(e){return null!=e&&!this.isWalkable(e)&&!e.isObstacle&&e.pos.distanceTo(this.posFloat)<1}},{key:"attemptMove",value:function(e){return!!this.verifyMove(e)&&(O.audio.currentTime=.05*Math.random(),O.gain.gain.cancelScheduledValues(0),O.gain.gain.value=1,O.gain.gain.linearRampToValueAtTime(0,O.gain.context.currentTime+.05),this.posFloat.add(e.dir.clone().setLength(this.speed)),this.autopickup(),!0)}},{key:"attemptStill",value:function(){return this.autopickup(),!0}},{key:"autopickup",value:function(){var e=this.currentTile();if(z(e)){var t=e.inventory;t.give(this.inventory,this.suckWater?t.water:0,this.suckSugar?t.sugar:0)}}},{key:"tryConstructingNewCell",value:function(e,t){e=e.clone();var n=this.world.tileAt(e.x,e.y);if(null!=n&&(null==this.world.fruit||t!==ye)&&!(n instanceof ye)){if(!(n instanceof t&&!(t===ge&&n instanceof ge))&&!n.isObstacle&&this.inventory.water>=1&&this.inventory.sugar>=1){this.inventory.add(-1,-1);var i=new t(e,this.world);return x.audio.currentTime=0,x.gain.gain.cancelScheduledValues(0),x.gain.gain.value=.2,x.gain.gain.exponentialRampToValueAtTime(1e-4,x.gain.context.currentTime+.5),i}}}},{key:"attemptBuild",value:function(e){var t=this.world.cellAt(e.position.x,e.position.y);if(null!=t&&t.constructor===e.cellType)return!0;t&&this.attemptDeconstruct({type:"deconstruct",position:e.position,force:!0});var n,i=this.tryConstructingNewCell(e.position,e.cellType);return null!=i&&((n=e.cellType.turnsToBuild?new pe(e.position,this.world,i):i).droopY=this.droopY(),this.world.setTileAt(e.position,n),!0)}},{key:"attemptBuildTransport",value:function(e){if(null==e.dir)return console.error("null dir",e),!0;this.world.cellAt(e.position.x,e.position.y)&&this.attemptDeconstruct({type:"deconstruct",position:e.position,force:!0});var t=this.tryConstructingNewCell(e.position,e.cellType);return null!=t&&(t.dir=e.dir,this.world.setTileAt(e.position,t),this.attemptMove({type:"move",dir:e.dir}),!0)}},{key:"attemptDeconstruct",value:function(e){if(!e.position.equals(this.pos)||e.force){var t=this.world.maybeRemoveCellAt(e.position);if(null!=t){var n=t.energy/q.cellEnergyMax;return this.inventory.add(n,n),z(t)&&t.inventory.give(this.inventory,t.inventory.water,t.inventory.sugar),!0}}return!1}},{key:"attemptDrop",value:function(e){var t=this.currentTile();if(z(t)){var n=e.water,i=e.sugar;return t.inventory.give(this.inventory,i,n),this.inventory.give(t.inventory,n,i),!0}return!1}},{key:"attemptMultiple",value:function(e){var t=!0,n=!0,i=!1,r=void 0;try{for(var a,o=e.actions[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value;t=this.attemptAction(s)&&t}}catch(l){i=!0,r=l}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return t}}]),e}();var Ee=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];Object(s.a)(this,e),this.deleted=t,this.added=n},Ae=function(){function e(t){var n=this;Object(s.a)(this,e),this.environment=t,this.time=0,this.width=50,this.height=100,this.player=new xe(new y.D(this.width/2,this.height/2),this),this.fruit=void 0,this.gridEnvironment=void 0,this.gridCells=void 0,this.neighborCache=void 0,this.cachedEntities=void 0,this.stepStats=new Ee,this.gridEnvironment=new Array(this.width).fill(void 0).map(function(e,i){return new Array(n.height).fill(void 0).map(function(e,r){var a,o=new y.D(i,r),s=!0,l=!1,u=void 0;try{for(var c,h=t.fill[Symbol.iterator]();!(s=(c=h.next()).done);s=!0){var d=(0,c.value)(o,n);if(null!=d){a=d;break}}}catch(p){l=!0,u=p}finally{try{s||null==h.return||h.return()}finally{if(l)throw u}}return null==a&&(a=new se(o,n)),a})});var i=this.player.pos.x,r=this.gridEnvironment[i].find(function(e){return!(e instanceof se)});r&&(this.player.pos.y=r.pos.y);this.gridCells=new Array(this.width).fill(void 0).map(function(e,t){return new Array(n.height).fill(void 0).map(function(e,i){var r=new y.D(t,i);return n.player.pos.distanceTo(r)<2.5?(n.gridEnvironment instanceof ue&&(n.gridEnvironment[t][i]=new le(new y.D(t,i),0,n)),new ve(r,n)):null})}),this.neighborCache=new Array(this.width).fill(void 0).map(function(e,t){return new Array(n.height).fill(void 0).map(function(e,i){return n.computeTileNeighbors(t,i)})}),this.fillCachedEntities()}return Object(l.a)(e,[{key:"tileAt",value:function(e,t){var n;if(e instanceof y.D?(n=e.x,t=e.y):(n=e,t=t),!this.isValidPosition(n,t))return null;var i=this.gridCells[n][t];return null!=i?i:this.gridEnvironment[n][t]}},{key:"cellAt",value:function(e,t){return this.isValidPosition(e,t)?this.gridCells[e][t]:null}},{key:"environmentTileAt",value:function(e,t){return this.isValidPosition(e,t)?this.gridEnvironment[e][t]:null}},{key:"setTileAt",value:function(e,t){var n=e.x,i=e.y;if(!this.isValidPosition(n,i))throw new Error("invalid position ".concat(n,", ").concat(i," "));t instanceof ye&&(null==this.fruit?this.fruit=t:console.warn("made multiple Fruit!"));var r=this.tileAt(n,i);z(r)&&(z(t)&&r.inventory.give(t.inventory,r.inventory.water,r.inventory.sugar),0===r.inventory.water&&0===r.inventory.sugar||(console.warn("lost",r.inventory,"resources to building"),r.inventory.add(-r.inventory.water,-r.inventory.sugar)));var a=this.gridCells[n][i];if(null!=a&&this.stepStats.deleted.push(a),t instanceof de)this.gridCells[n][i]=t;else{this.gridCells[n][i]=null;var o=this.gridEnvironment[n][i];null!=o&&this.stepStats.deleted.push(o),this.gridEnvironment[n][i]=t}this.stepStats.added.push(t),this.handleTileUpdated(e)}},{key:"maybeRemoveCellAt",value:function(e){var t=this.cellAt(e.x,e.y);return t&&(this.gridCells[e.x][e.y]=null,t===this.fruit&&(this.fruit=void 0),this.stepStats.deleted.push(t)),this.handleTileUpdated(e),t}},{key:"isValidPosition",value:function(e,t){return!(e>=this.width||e<0||t>=this.height||t<0)}},{key:"tileNeighbors",value:function(e){return this.neighborCache[e.x][e.y]}},{key:"computeTileNeighbors",value:function(e,t){var n=this,i=new Map;return Me[this.time%Me.length].forEach(function(r){var a=e+r.x,o=t+r.y,s=n.tileAt(a,o);null!=s&&i.set(r,s)}),i}},{key:"entities",value:function(){if(null==this.cachedEntities)throw new Error("accessed entities before filling");return this.cachedEntities}},{key:"handleTileUpdated",value:function(e){this.neighborCache[e.x][e.y]=this.computeTileNeighbors(e.x,e.y);var t=!0,n=!1,i=void 0;try{for(var r,a=ne[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value,s=e.x+o.x,l=e.y+o.y;this.isValidPosition(s,l)&&(this.neighborCache[s][l]=this.computeTileNeighbors(s,l))}}catch(u){n=!0,i=u}finally{try{t||null==a.return||a.return()}finally{if(n)throw i}}this.fillCachedEntities()}},{key:"fillCachedEntities",value:function(){var e=[],t=0,n=0;for(t=0;t<this.width;t++)for(n=(t+this.time)%2;n<this.height;n+=2)e.push(this.tileAt(t,n));for(t=0;t<this.width;t++)for(n=(t+this.time+1)%2;n<this.height;n+=2)e.push(this.tileAt(t,n));this.time%4<2&&e.reverse(),e.push(this.player),this.cachedEntities=e}},{key:"step",value:function(){var e=this.entities();return this.stepStats=new Ee,e.forEach(function(e){"function"===typeof e.step&&e.step()}),this.computeSunlight(),this.stepWeather(),this.time++,this.fillCachedEntities(),this.stepStats}},{key:"getLastStepStats",value:function(){return this.stepStats}},{key:"stepWeather",value:function(){if((this.time+this.environment.climate.turnsBetweenRainfall-200)%this.environment.climate.turnsBetweenRainfall<this.environment.climate.rainDuration){var e=y.p.randInt(0,this.width-1),t=this.tileAt(e,0);t instanceof se&&t.inventory.add(this.environment.climate.waterPerDroplet,0)}}},{key:"computeSunlight",value:function(){for(var e=this.time*Math.PI*2/1e3,t=Math.sin(e+Math.PI/2),n=Math.atan(12*Math.sin(e))/(Math.PI/2)*.5+.5,i=0;i<=.6*this.height;i++)for(var r=0;r<this.width;r++){var a=this.environmentTileAt(r,i);if(a instanceof se){var o=0;if(0===i)o=1;else{var s=this.tileAt(r,i-1),l=this.tileAt(r+1,i-1),u=this.tileAt(r-1,i-1),c=s instanceof se?s.sunlightCached/n:null==s?1:0,h=l instanceof se?l.sunlightCached/n:null==l?1:0,d=u instanceof se?u.sunlightCached/n:null==u?1:0;o=(o=t>0?h*t+c*(1-t):d*-t+c*(1- -t))*(1-q.sunlightDiffusion)+(c+h+d)/3*q.sunlightDiffusion}o=q.sunlightReintroduction+o*(1-q.sunlightReintroduction),o*=n,a.sunlightCached=o}}}},{key:"checkWinLoss",value:function(){return null!=this.fruit&&this.fruit.inventory.sugar>ye.sugarToWin?"win":this.tileAt(this.player.pos.x,this.player.pos.y)instanceof ce?"lose":"win"}},{key:"checkResources",value:function(){this.entities().forEach(function(e){z(e)&&(e.inventory.sugar,e.inventory.water),ie(e)&&e.energy})}}]),e}();function Se(e){for(var t,n,i=e.length;0!==i;)n=Math.floor(Math.random()*i),t=e[i-=1],e[i]=e[n],e[n]=t;return e}var Me=[Se(ne.slice()),Se(ne.slice()),Se(ne.slice()),Se(ne.slice()),Se(ne.slice())],Ce=n(27);function Te(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=Ne(e.width,e.height,function(t,n,i){var r=e.tileAt(t,n);null!=r&&e.player.isWalkable(r)&&i.setWalkableAt(t,n,!0)});i.setWalkableAt(t.x,t.y,!0);var r=De(i,e.player.pos,t);return e.tileAt(t)instanceof de||n?r:(r.pop(),r)}function Re(e,t){return De(Ne(e.width,e.height,function(t,n,i){var r=e.tileAt(t,n);(r instanceof ve||!(r instanceof de)&&!r.isObstacle)&&i.setWalkableAt(t,n,!0)}),e.player.pos,t)}function Pe(e){for(var t=[],n=0;n<e.length-1;n++){var i=Object(K.a)(e[n],2),r=i[0],a=i[1],o=Object(K.a)(e[n+1],2),s=Fe(r,a,o[0],o[1]);if(null==s)throw new Error("couldn't find corresponding movement action");t.push(s)}return t}function De(e,t,n){return new Ce.AStarFinder({diagonalMovement:Ce.DiagonalMovement.Always}).findPath(t.x,t.y,n.x,n.y,e)}function Ne(e,t,n){for(var i=new Ce.Grid(e,t),r=0;r<e;r++)for(var a=0;a<t;a++)i.setWalkableAt(r,a,!1);for(var o=0;o<e;o++)for(var s=0;s<t;s++)n(o,s,i);return i}function Fe(e,t,n,i){var r=n-e,a=i-t;return je.find(function(e){var t=e.dir;return t.x===r&&t.y===a})}function We(e){var t;return function(){return void 0===t&&(t=e()),t}}var Be=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(c.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return null}},{key:"componentDidMount",value:function(){this.props.parent.add(this.props.object)}},{key:"componentWillUnmount",value:function(){this.props.parent.remove(this.props.object)}}]),t}(i.PureComponent),Le=We(function(){var e=new y.u(1,1),t=new y.k(e,1),n=new y.n({color:16777215,transparent:!0,opacity:.75}),i=new y.o(t,n);return i.position.z=10,i}),Ie=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).object=Le().clone(),n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this;return this.object.position.x=this.props.x,this.object.position.y=this.props.y,i.createElement(i.Fragment,null,i.createElement(ze,{a:function(t){return e.object.scale.setScalar(.04*Math.sin(3.7*t)+.94)}}),i.createElement(Be,{object:this.object,parent:this.props.scene}))}}]),t}(i.PureComponent),ze=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).rafid=void 0,n.animate=function(e){n.props.a(e/1e3),n.rafid=requestAnimationFrame(n.animate)},n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return null}},{key:"componentDidMount",value:function(){this.rafid=requestAnimationFrame(this.animate)}},{key:"componentWillUnmount",value:function(){this.rafid&&cancelAnimationFrame(this.rafid)}}]),t}(i.Component),Ye=Ie;i.PureComponent;var Ue=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(c.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this;return i.createElement("div",{className:"mito-instructions"},i.createElement("div",{className:"mito-instructions-container"},i.createElement("div",{className:"esc",onClick:function(){return e.props.play()}},"Back (Esc)"),i.createElement("h1",null,"Mito"),i.createElement("div",{className:"play-button",onClick:function(){return e.props.play()}},"Play"),i.createElement("p",null,i.createElement("ol",null,i.createElement("li",null,"Build Tissue to expand your reach (press t and walk into empty space)."),i.createElement("li",null,"Build Roots (press r) underground to suck up adjacent water."),i.createElement("li",null,"Build Leaves (press l) above ground and drop water (press 1) to convert water into sugar."),i.createElement("li",null,i.createElement("b",null,"Win the game by building and loading the Fruit with 1000 sugar.")),i.createElement("li",null,"Click around to see the different properties of each tile."),i.createElement("li",null,"Build leaves early."),i.createElement("li",null,"Leaves higher up have better water/sugar ratios, determined by the co2 percentage in the air."),i.createElement("li",null,"Explore underground for water reservoires and Fountains."),i.createElement("li",null,"Build transports (capital T) to carry water back up the plant."),i.createElement("li",null,"You can scroll out infinitely far."))),i.createElement("h3",null,"You"),i.createElement("p",null,"You can carry max ",q.maxResources," resources, and you automatically suck in any resources you're standing over. You can only walk on Tissue (and Transport). You start at the center of the map, with soil below and air above."),i.createElement("h3",null,"Soil and Underground"),i.createElement("p",null,"Underground, Soil holds water, rocks block your way, and occasionally Fountains (at the very bottom) are a permanent source of water. Soil holds up to ",q.soilMaxWater," water at a time. Fountains emit one water per ",q.fountainTurnsPerWater," turns."),i.createElement("h3",null,"Air and Aboveground"),i.createElement("p",null,"Aboveground, Air provides both sunlight and co2. Sunlight determines the ratio of waters-per-sugar at which reactions happen and are affected by shadows. Co2 determines the speed of reaction and gets better as you build higher up. Orange is low co2, blue is high co2. Gravity will pull down on your structures, so make sure they're structurally sound. Your structures cast shadows on the leaves below in relation to the sun, which gently sways left to right."),i.createElement("h3",null,"Water"),i.createElement("p",null,"Water is one of the main two resources. Water slowly diffuses from high to low densities (difference 2 required) at about 1 unit per ",(1/q.soilDiffusionWater).toFixed(0)," turns. Obtain water in the ground through Roots. Leaves require water to photosynthesize. You require water to build."),i.createElement("h3",null,"Sugar"),i.createElement("p",null,"Sugar is the other main resource. Sugar does not diffuse. Leaves convert water into sugar. Obtain sugar by putting water next to leaves. Cells require sugar to survive. You require sugar to build."),i.createElement("h3",null,"Building"),i.createElement("p",null,'Build Tissue, Leaves, Roots, and The Fruit by toggling "build mode" on and walking into Air or Soil. Build Transport over existing tissue by walking around. Building costs 1 sugar and 1 water. You can build Tissue over Leaves and Roots - be careful! When you build above ground, Cells will Droop if they\'re not properly supported underneath them.'),i.createElement("h3",null,"Cells"),i.createElement("p",null,"All cells require energy upkeep and will automatically eat sugar on their tile, or get energy from their neighbors. Each cell consumes 1 sugar every ",q.cellEnergyMax," turns."),i.createElement("h3",null,"Tissue"),i.createElement("p",null,"Tissue connects your plant together, you may only walk on Tissue. Each Tissue carries up to ",q.tissueInventoryCapacity," resources."),i.createElement("h3",null,"Roots"),i.createElement("p",null,"Roots are the only way to get water. Each turn Roots transport one water per neighboring soil into the Tissue in the opposite direction (so the Tissue North of the root get water in the South tile). This is called a Pairing."),i.createElement("h3",null,"Leaves"),i.createElement("p",null,"When exposed to Air, Leaves convert water to sugar. Leaves also use Pairings between opposite direction Air/Tissue with water. In perfect co2, leave produce on average 1 sugar per ",(1/q.leafReactionRate).toFixed(0)," turns per pair. Leaf efficiency is heavily influenced by co2 and sunlight of its neighboring Air. If your leaf is in too much shadow, it will not be able to photosynthesize. Leaves higher up produce sugar faster."),i.createElement("h3",null,"Transport"),i.createElement("p",null,"Transports move 1 water from its own Tile in the direction it was laid per turn, as well as moving you. Transport hungers at double speed."),i.createElement("h3",null,"The Fruit"),i.createElement("p",null,"You can only build one Fruit, and it is the goal of the game to fill it up with resources. Fruit has up to 1000 sugar storage and aggressively pulls in every available sugar in its surrounding vicinity."),this.renderCredit()))}},{key:"renderCredit",value:function(){return i.createElement(i.Fragment,null,i.createElement("h2",null,"Attribution"),i.createElement("p",null,"Tiles: ",i.createElement("a",{href:"http://kenney.nl/assets?s=roguelike",target:"_blank",rel:"noopener noreferrer"},"Kenney.nl Roguelike Assets")),i.createElement("p",null,"Pop sound when leaves convert: ",i.createElement("a",{href:"http://soundbible.com/2067-Blop.html",target:"_blank",rel:"noopener noreferrer"},"Blop by Mark DiAngelo")," (",i.createElement("a",{href:"https://creativecommons.org/licenses/by/3.0/us/"},"CC BY 3.0 US"),")"),i.createElement("p",null,"Perlin noise: ",i.createElement("a",{href:"https://github.com/josephg/noisejs",target:"_blank",rel:"noopener noreferrer"},"josephg/noisejs")),i.createElement("p",null,"Part of 7drl 2018: ",i.createElement("a",{href:"http://7drl.org/",target:"_blank",rel:"noopener noreferrer"},"http://7drl.org/")),i.createElement("p",null,"Fruit icon: ",i.createElement("a",{href:"https://www.freepik.com/free-vector/fruits-set-pixel-icons_1001072.htm"},"Designed by Freepik")))}}]),t}(i.PureComponent),qe=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).handlePlay=function(){n.props.mito.gameState="main"},n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e={width:"100%",height:"100%",position:"absolute",background:"rgba(255, 255, 255, 0.95)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"40px"};return"main"===this.props.state?null:"win"===this.props.state?i.createElement("div",{className:"screen-win",style:e},"You won!"):"lose"===this.props.state?i.createElement("div",{className:"screen-lose",style:e},"You lost!"):"instructions"===this.props.state?i.createElement(Ue,{play:this.handlePlay}):void 0}}]),t}(i.PureComponent),Ve=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(c.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this.props.tile;return e?i.createElement("div",{className:"tile-hover"},this.tileInfo(e),this.inventoryInfo(e),this.cellInfo(e),this.growingCellInfo(e),this.rootInfo(e),this.leafInfo(e),this.airInfo(e),this.fountainInfo(e)):null}},{key:"rootInfo",value:function(e){return e instanceof me?i.createElement("div",{className:"info-root"},i.createElement("div",null,e.cooldown," turns until next water suck"),i.createElement("div",null,e.waterTransferAmount.toFixed(0)," water transfer per round")):null}},{key:"leafInfo",value:function(e){return e instanceof fe?i.createElement("div",{className:"info-leaf"},i.createElement("div",null,(1/(e.averageSpeed*q.leafReactionRate)).toFixed(0)," turns per reaction"),i.createElement("div",null,(1/e.averageEfficiency).toFixed(2)," water per sugar")):null}},{key:"airInfo",value:function(e){if(e instanceof se)return i.createElement("div",{className:"info-air"},i.createElement("div",null,"\u2600\ufe0f ",(100*e.sunlight()).toFixed(0),"%"),i.createElement("div",null,"\u2601\ufe0f ",(100*e.co2()).toFixed(0),"%"))}},{key:"fountainInfo",value:function(e){if(e instanceof he)return i.createElement("div",{className:"info-fountain"},i.createElement("div",null,e.turnsPerWater," turns per water"))}},{key:"tileInfo",value:function(e){var t=ie(e)?i.createElement("span",{className:"info-energy"},"\ud83d\udc9a",(e.energy/q.cellEnergyMax*100).toFixed(0),"%"):null;return i.createElement("div",{className:"info-tile"},i.createElement("div",{className:"info-tile-name"},e.constructor.displayName),t)}},{key:"inventoryInfo",value:function(e){if(z(e)){var t=e.inventory.water>0?i.createElement("div",{className:"info-inventory-item"},"\ud83d\udca7 ",e.inventory.water.toFixed(2)):null,n=e.inventory.sugar>0?i.createElement("div",{className:"info-inventory-item"},"Sugar ",e.inventory.sugar.toFixed(2)):null;return i.createElement("div",{className:"info-inventory"},t,n)}}},{key:"cellInfo",value:function(e){if(e instanceof de&&200*e.droopY>1)return i.createElement("div",{className:"info-cell"},(200*e.droopY).toFixed(0),"% droop")}},{key:"growingCellInfo",value:function(e){if(e instanceof pe)return i.createElement("div",{className:"info-growing-cell"},(100-e.timeRemaining/e.timeToBuild*100).toFixed(0),"% mature")}}]),t}(i.Component),Ge=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(c.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this.props.water+this.props.sugar>q.maxResources-1,t=i.createElement("div",{className:"mito-inventory-maxed".concat(e?" is-maxed":"")},"maxed");return i.createElement(i.Fragment,null,i.createElement("div",{className:m()("mito-hud",{hidden:!this.props.isTutorialFinished})},this.renderFruitUI(),this.renderAllBuildButtons(),this.renderSecondEls(),this.renderDPad()),i.createElement("div",{className:m()("mito-inventory",{hidden:!1})},t,i.createElement("div",{className:"mito-inventory-container"},this.renderInventoryBar(),this.renderInventory())),this.renderUIState(),this.renderAutoplacePopup())}},{key:"ensureCanvasFocus",value:function(e){e.preventDefault(),document.getElementsByTagName("canvas")[0].focus()}},{key:"renderButton",value:function(e,t,n){var r=this;return i.createElement("div",Object.assign({key:e,className:"mito-hud-button mito-hud-build-item",onClick:function(t){r.props.onTryActionKey(e),r.ensureCanvasFocus(t)}},n),i.createElement("span",{className:"mito-hud-button-hotkey"},e),t)}},{key:"renderBuildButton",value:function(e,t){var n,i=Oe[e];n=i===ve?"Build ".concat(i.displayName):i===fe||i===me?"Build ".concat(i.displayName):i===ye?"Build ".concat(i.displayName):i===ge?"Lay ".concat(i.displayName):"Build ".concat(i.displayName);var r=Object(Y.a)({},(t||{style:{}}).style);return this.props.autoplace===i&&(r.fontWeight="bold",r.textDecoration="underline",r.color="rgb(45, 220, 40)",this.props.water<1&&(n+=" (need water!)",r.color="red"),this.props.sugar<1&&(n+=" (need sugar!)",r.color="red")),this.renderButton(e," - "+n,Object(Y.a)({},t,{style:r}))}},{key:"renderInventory",value:function(){return i.createElement("div",{className:"mito-inventory-indicator"},i.createElement("span",{className:"mito-inventory-water"},this.props.water.toFixed(2)," water"),"\xa0",i.createElement("span",{className:"mito-inventory-sugar"},this.props.sugar.toFixed(2)," sugar"))}},{key:"renderInventoryBar",value:function(){var e=this.props.water/q.maxResources,t=this.props.sugar/q.maxResources,n=1-(this.props.water+this.props.sugar)/q.maxResources,r={width:"".concat(100*e,"%")},a={width:"".concat(100*t,"%")},o={width:"".concat(100*n,"%")};return i.createElement("div",{className:"mito-inventory-bar"},i.createElement("div",{style:r,className:"mito-inventory-bar-water"}),i.createElement("div",{style:a,className:"mito-inventory-bar-sugar"}),i.createElement("div",{style:o,className:"mito-inventory-bar-empty"}))}},{key:"renderAllBuildButtons",value:function(){var e=[];for(var t in Oe)if("F"!==t){var n=this.renderBuildButton(t);null!=n&&e.push(n)}return null==this.props.world.fruit&&Oe.F&&e.push(this.renderBuildButton("F")),i.createElement("div",{className:"mito-hud-section mito-hud-section-build"},e)}},{key:"renderSecondEls",value:function(){return i.createElement("div",{className:"mito-hud-section mito-hud-section-actions"},this.renderButton("1"," - Drop water"),this.renderButton("2"," - Drop sugar"),this.renderButton("."," - Wait a turn"),this.renderButton("?"," - Instructions"))}},{key:"renderDPad",value:function(){var e=[],t=!0,n=!1,r=void 0;try{for(var a,o="qwea.dzsc".split("")[Symbol.iterator]();!(t=(a=o.next()).done);t=!0){var s=a.value;e.push(this.renderButton(s,null,{style:{}}))}}catch(l){n=!0,r=l}finally{try{t||null==o.return||o.return()}finally{if(n)throw r}}return i.createElement("div",{className:"mito-hud-section d-pad"},e)}},{key:"renderFruitUI",value:function(){var e=this.props.world;if(null!=e.fruit)return i.createElement("div",{className:"mito-hud-section"},"You bear Fruit! ",e.fruit.inventory.sugar.toFixed(2)," of ",ye.sugarToWin," sugar!")}},{key:"renderUIState",value:function(){if("expanding"===this.props.uiState.type){var e=[];for(var t in Oe){var n=Oe[t];if((n!==ye||null==this.props.world.fruit)&&n!==ge){var r=this.renderButton(t,n.displayName);null!=r&&e.push(r)}}return e.push(this.renderButton("Esc",null)),i.createElement("div",{className:"ui-popup ui-popup-bottom"},i.createElement("div",{className:"connector-line"}),i.createElement("span",{className:"popup-title"},"Build"),i.createElement("div",{className:"popup-content popup-row"},e))}}},{key:"renderAutoplacePopup",value:function(){if(this.props.autoplace){var e={left:this.props.mouseX,top:this.props.mouseY};return i.createElement("div",{className:"popup-autoplace ui-popup",style:e},i.createElement("div",{className:"popup-content popup-text"},"Building ",this.props.autoplace.displayName,this.renderButton("Esc",null)))}}}]),t}(i.PureComponent),_e=n(41),Ke=We(function(){var e=new ee,t=new ee,n=new ee;return{climate:{turnsBetweenRainfall:800,rainDuration:50,waterPerDroplet:2},evaporationRate:2e-4,evaporationBottom:.6,floorCo2:.5,waterGravityPerTurn:.001,fill:[function(i,r){var a=i.x,o=i.y,s=r.height/2-4*(n.perlin2(0,a/5)+1)/2-16*n.perlin2(10,a/20+10),l=D(o-r.height/2,0,r.height/2,-.7,.3),u=t.simplex2(a/5,o/5)<l;if(o>s){if(u)return new ue(i,r);var c=Math.pow(D(o-r.height/2,0,r.height/2,.5,1),2),h=e.simplex2(.2*a,.2*o)+.2,d=Math.round(Math.max(1,Math.min(20,h>.4?20*c:0)));if(c*h>1/q.fountainAppearanceRate){var p=Math.min(c*h,1);return new he(i,d,r,Math.round(q.fountainTurnsPerWater/p))}return new le(i,d,r)}}]}}),He=We(function(){var e=new ee,t=new ee;return{climate:{rainDuration:220,turnsBetweenRainfall:3e3,waterPerDroplet:8},evaporationRate:.002,evaporationBottom:.7,waterGravityPerTurn:.02,floorCo2:.95,fill:[function(n,i){var r=n.x,a=n.y,o=i.height/2-2*(e.perlin2(0,r/20)+1)/2-3*e.perlin2(10,r/100+10),s=D(a,i.height/2,i.height,-.8,-.4),l=t.simplex2(r/4,a/4)<s;if(a>o){if(l)return new ue(n,i);var u=Math.floor(Math.max(0,D(a,.75*i.height,i.height,1,9)));return new le(n,u,i)}}]}}),Xe=We(function(){var e=new ee,t=new ee;return{climate:{turnsBetweenRainfall:1200,rainDuration:120,waterPerDroplet:3},waterGravityPerTurn:.1,evaporationBottom:.6,evaporationRate:.001,floorCo2:1,fill:[function(n,i){var r=n.x,a=n.y,o=.55*i.height-4*(t.perlin2(0,r/5)+1)/2-16*t.perlin2(10,r/20+10)-D(r,0,i.width,10,-10),s=a-6*(t.perlin2(0,r/25)+1)/2-20*t.perlin2(10,r/150+10)<.5*i.height?-1:-.15;return e.simplex2(r/10,a/10)<s?new ue(n,i):a>o?new le(n,3,i):void 0}]}}),Je={Temperate:Ke,Desert:He,Rocky:Xe},Ze=function(e){function t(e){var n;Object(s.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this,e))).gui=void 0;var i=new _e.a({closed:!0,width:450});i.add(q,"environment",Object.keys(Je)).onChange(function(){return setTimeout(function(){return window.location.reload()},100)}),i.add(q,"droop",0,.5,.01),i.add(q,"fountainTurnsPerWater",1,100,1),i.add(q,"isRealtime"),i.add(q,"leafReactionRate",0,.2,1e-4),i.add(q,"leafSugarPerReaction",0,1,.01),i.add(q,"rootTurnsPerTransfer",1,100,1),i.add(q,"soilDarknessBase",0,1,.01),i.add(q,"soilDiffusionType",["discrete","continuous"]),i.add(q,"sunlightReintroduction",0,1,.01),i.add(q,"sunlightDiffusion",0,1,.01),i.add(q,"transportTurnsPerMove",1,50,1),i.add(q,"veinDiffusion",0,.85,1e-4);var r=i.addFolder("Needs Page Refresh");r.add(q,"cellGestationTurns",0,100,1),r.add(q,"cellDiffusionSugar",0,.85,1e-4),r.add(q,"cellDiffusionWater",0,.85,1e-4),r.add(q,"cellEnergyMax",400,1e4,100),r.add(q,"fountainAppearanceRate",1,5,.1),r.add(q,"maxResources",10,1e3,1),r.add(q,"soilDiffusionWater",0,.25,1e-5),r.add(q,"soilMaxWater",1,100,1),r.add(q,"tissueInventoryCapacity",1,100,1);var a=!0,o=!1,l=void 0;try{for(var h,d=i.__controllers.concat(r.__controllers)[Symbol.iterator]();!(a=(h=d.next()).done);a=!0){h.value.onFinishChange(G)}}catch(p){o=!0,l=p}finally{try{a||null==d.return||d.return()}finally{if(o)throw l}}return n.gui=i,n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return null}}]),t}(i.Component),Qe=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(c.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this.props.mito.hoveredTile;return i.createElement(i.Fragment,null,i.createElement(Ve,{tile:e}),this.maybeRenderHoveredTileHighlight(e),this.maybeRenderPath())}},{key:"maybeRenderHoveredTileHighlight",value:function(e){if(e)return i.createElement(Ye,{x:e.pos.x,y:e.pos.y,scene:this.scene})}},{key:"maybeRenderPath",value:function(){var e=this.props.mito,t=e.autoplace,n=e.hoveredTile,r=e.scene,a=e.world;if(n){if(null!=t&&-1!==At.expansionTiles.indexOf(t))return i.createElement($e,{tile:n,scene:r,world:a,walkable:"non-obstacles"});if(t===ge)return i.createElement($e,{tile:n,scene:r,world:a,walkable:"tissue"})}}},{key:"scene",get:function(){return this.props.mito.scene}}]),t}(i.Component),$e=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(c.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this,t="non-obstacles"===this.props.walkable?Re(this.props.world,this.props.tile.pos):Te(this.props.world,this.props.tile.pos);return i.createElement(i.Fragment,null,t.map(function(t){var n=Object(K.a)(t,2),r=n[0],a=n[1];return i.createElement(Ye,{x:r,y:a,scene:e.props.scene})}))}}]),t}(i.PureComponent),et=n(42),tt=function e(t,n,i){Object(s.a)(this,e),this.target=t,this.scene=n,this.mito=i},nt=new y.v(1,1);function it(e){var t=document.createElement("canvas");t.width=64,t.height=64;var n=t.getContext("2d");n.font="".concat(32,"px monospace"),n.textAlign="center",n.textBaseline="middle",n.fillStyle="white",n.fillText(e,32,32);var i=new y.h(t);i.flipY=!0;var r=new y.r({map:i,transparent:!0,side:y.j});return new y.q(nt,r)}nt.rotateX(Math.PI);var rt=new Map;for(var at in ke)rt.set(at,it(at));var ot=16,st=!1,lt=We(function(){return(new y.C).load("assets/images/roguelikeSheet_transparent.png",function(){lt().dispatchEvent({type:"update"}),st=!0})}),ut=(new y.C).load("assets/images/fruit.png"),ct={};function ht(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"white";e=Math.floor(e),t=Math.floor(t);var i="".concat(e,",").concat(t);if(null==ct[i]){var r=function(){var i=lt().image,r=a.getContext("2d");r.fillStyle=n,r.fillRect(0,0,ot,16),r.drawImage(i,ot*e,ot*t,ot,ot,0,0,ot,ot),o.needsUpdate=!0},a=document.createElement("canvas");a.width=ot,a.height=ot;var o=new y.B(a);o.magFilter=y.s,o.flipY=!0,o.wrapS=y.y,o.wrapT=y.y,st?r():lt().addEventListener("update",function(){r()}),ct[i]=o}return ct[i]}var dt=function(e){function t(e,n,i){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(c.a)(t).call(this,e,n,i))).mesh=void 0,r.mesh=new y.q(new y.u(1,1),new y.r({transparent:!0,depthWrite:!1,depthTest:!1,map:ht(29,12,"transparent"),color:new y.i("white"),side:y.j})),P(r.mesh.position,r.target.pos,1),r.mesh.position.z=2,r.scene.add(r.mesh),r}return Object(h.a)(t,e),Object(l.a)(t,[{key:"update",value:function(){var e=this.target.droopPosFloat().clone();e.x+=.04*Math.cos(performance.now()/1e3),e.y+=.08*Math.sin(performance.now()/400),P(this.mesh.position,e,.5),this.mesh.position.z=2;var t=!0,n=!1,i=void 0;try{for(var r,a=rt[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value,s=Object(K.a)(o,2),l=s[0],u=s[1],c=ke[l],h=this.target.pos.x+c.dir.x,d=this.target.pos.y+c.dir.y;this.target.isBuildCandidate(this.mito.world.tileAt(h,d))&&"main"===this.mito.uiState.type?(this.scene.add(u),u.position.x=h,u.position.y=d,u.position.z=2):this.scene.remove(u)}}catch(p){n=!0,i=p}finally{try{t||null==a.return||a.return()}finally{if(n)throw i}}}},{key:"destroy",value:function(){this.scene.remove(this.mesh)}}]),t}(tt),pt=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this))).geometry=void 0,n.material=void 0,n.index=0,n.geometry=t.newGeometry(),n.material=new vt(e),n.frustumCulled=!1,n}return Object(h.a)(t,e),Object(l.a)(t,null,[{key:"newGeometry",value:function(){var e=new y.g,n=new Float32Array(3*t.BUFFER_SIZE),i=new Float32Array(t.BUFFER_SIZE);return e.addAttribute("position",new y.f(n,3).setDynamic(!0)),e.addAttribute("size",new y.f(i,1).setDynamic(!0)),e}}]),Object(l.a)(t,[{key:"startFrame",value:function(){this.index=0}},{key:"commit",value:function(e,t,n,i){this.geometry.attributes.position.setXYZ(this.index,e,t,n),this.geometry.attributes.size.setX(this.index,i),this.index++}},{key:"endFrame",value:function(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.size.needsUpdate=!0,this.geometry.setDrawRange(0,this.index)}}]),t}(y.w);pt.BUFFER_SIZE=1e5;var vt=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this,{uniforms:{opacity:{value:e.opacity},sizeGlobal:{value:e.size},color:{value:e.color},map:{value:e.map}},vertexShader:ft,fragmentShader:mt,depthTest:!1,transparent:!0}))).params=e,n.map=void 0,n.map=e.map,n}return Object(h.a)(t,e),t}(y.A),ft="\nattribute float size;\nuniform float sizeGlobal;\n\nvoid main() {\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    gl_PointSize = size * sizeGlobal * -projectionMatrix[1].y;\n    gl_Position = projectionMatrix * mvPosition;\n}\n",mt="\nuniform vec3 color;\nuniform sampler2D texture;\nuniform float opacity;\n\n#ifdef USE_MAP\n\tuniform mat3 uvTransform;\n\tuniform sampler2D map;\n#endif\n\nvoid main() {\n    gl_FragColor = vec4( color, opacity );\n\n    #ifdef USE_MAP\n        vec4 mapTexel = texture2D( map, gl_PointCoord );\n        gl_FragColor *= mapTexelToLinear( mapTexel );\n    #endif\n}\n",yt=function(e){function t(e,n,i){var r;Object(s.a)(this,t),(r=Object(u.a)(this,Object(c.a)(t).call(this,e,n,i))).animationOffset=0,r.waters=[],r.sugars=[],r.handleGetResources=function(e){for(var t=Math.ceil(r.target.water);r.waters.length<t;){var n=e.carrier.pos.clone().sub(r.target.carrier.pos);n.x+=.1*(Math.random()-.5),n.y+=.1*(Math.random()-.5),r.waters.push(n)}for(t=Math.ceil(r.target.sugar);r.sugars.length<t;){var i=e.carrier.pos.clone().sub(r.target.carrier.pos);i.x+=.1*(Math.random()-.5),i.y+=.1*(Math.random()-.5),r.sugars.push(i)}},r.handleGiveResources=function(){var e=Math.ceil(r.target.water);r.waters.length>e&&r.waters.splice(e,r.waters.length-e),e=Math.ceil(r.target.sugar),r.sugars.length>e&&r.sugars.splice(e,r.sugars.length-e)},e.on("get",r.handleGetResources),e.on("give",r.handleGiveResources);for(var a=0;a<r.target.water;a++)r.waters.push(gt());for(var o=0;o<r.target.sugar;o++)r.sugars.push(gt());return r}return Object(h.a)(t,e),Object(l.a)(t,null,[{key:"startFrame",value:function(){t.WaterParticles().startFrame(),t.SugarParticles().startFrame()}},{key:"endFrame",value:function(){t.WaterParticles().endFrame(),t.SugarParticles().endFrame()}}]),Object(l.a)(t,[{key:"updateNumParticles",value:function(e){}},{key:"commitParticles",value:function(e,t,n){if(n.length>0){for(var i=0;i<n.length-1;i++){var r=n[i];e.commit(r.x+this.target.carrier.pos.x,r.y+this.target.carrier.pos.y,10,1),t-=1}var a=n[n.length-1],o=t;e.commit(a.x+this.target.carrier.pos.x,a.y+this.target.carrier.pos.y,10,o)}}},{key:"simulateResourcePositions",value:function(){var e=this.waters.concat(this.sugars),t=!0,n=!1,i=void 0;try{for(var r,a=e[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=r.value,s=0,l=0,u=performance.now()/3e3+this.animationOffset;s+=.02*Math.cos(u);var c=.1+.1*o.length();if(s+=-o.x*c,l+=-o.y*c,this.mito.world.player.pos.equals(this.target.carrier.pos)){var h=Math.max(Math.min(D(o.lengthSq(),0,1,3,-5),3),0),d=o.clone().multiplyScalar(.2*h);s+=d.x,l+=d.y}var p=!0,v=!1,f=void 0;try{for(var m,y=e[Symbol.iterator]();!(p=(m=y.next()).done);p=!0){var g=m.value;if(o===g)break;var w=o.x-g.x,b=o.y-g.y,k=w*w+b*b;if(k>0){var j=.003/k;s+=w*j,l+=b*j}}}catch(O){v=!0,f=O}finally{try{p||null==y.return||y.return()}finally{if(v)throw f}}o.x+=s,o.y+=l}}catch(O){n=!0,i=O}finally{try{t||null==a.return||a.return()}finally{if(n)throw i}}}},{key:"update",value:function(){this.updateNumParticles(this.target.water),this.updateNumParticles(this.target.sugar),this.simulateResourcePositions(),this.commitParticles(t.WaterParticles(),this.target.water,this.waters),this.commitParticles(t.SugarParticles(),this.target.sugar,this.sugars)}},{key:"destroy",value:function(){}}]),t}(tt);function gt(){return new y.D(.01*(Math.random()-.5),.01*(Math.random()-.5))}yt.WaterParticles=We(function(){return new pt({color:new y.i("rgb(9, 12, 255)"),size:45,opacity:.75})}),yt.SugarParticles=We(function(){return new pt({color:new y.i("yellow"),size:85,opacity:.9,map:ht(42,12,"transparent")})});var wt=function(e){function t(e){var n,i;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(c.a)(t).call(this,t.geometry,(i=e.target,kt().get(i.constructor).clone())))).renderer=e,n}return Object(h.a)(t,e),t}(y.q);wt.geometry=new y.u(1,1);var bt=function(e){function t(e,n,i){var r;Object(s.a)(this,t),(r=Object(u.a)(this,Object(c.a)(t).call(this,e,n,i))).mesh=void 0,r.inventoryRenderer=void 0,r.originalColor=void 0,r.audio=void 0,r.lastAudioValueTracker=0,r.pairsLines=[],r.growingRenderer=void 0,r.target instanceof pe?(r.growingRenderer=new t(r.target.completedCell,r.scene,r.mito),r.mesh=r.growingRenderer.mesh):r.mesh=new wt(Object(R.a)(r)),r.originalColor=r.mesh.material.color.clone(),z(r.target)&&(r.inventoryRenderer=new yt(r.target.inventory,r.scene,r.mito),r.inventoryRenderer.animationOffset=(r.target.pos.x+r.target.pos.y)/2),r.scene.add(r.mesh);var a=r.target instanceof de?1:0;return r.mesh.position.set(r.target.pos.x,r.target.pos.y,a),r.target instanceof de?r.target.constructor.turnsToBuild||r.mesh.scale.set(.01,.01,1):r.mesh.matrixAutoUpdate=!1,r.mesh.updateMatrix(),(r.target instanceof fe||r.target instanceof me)&&(r.audio=new y.b(r.mito.audioListener),r.mesh.add(r.audio)),r}return Object(h.a)(t,e),Object(l.a)(t,[{key:"steps",value:function(e,t){return Math.floor(e/t)*t}},{key:"update",value:function(){var e=this;if(this.target instanceof pe){var t=D(1.001-this.target.timeRemaining/this.target.timeToBuild,0,1,.2,1);P(this.mesh.scale,{x:t,y:t},.1)}else P(this.mesh.scale,new y.D(1,1),.1);var n=this.target.lightAmount(),i=this.mesh.material;if(this.target instanceof se){var r=Math.max(0,D(this.target.co2(),1/6,1.001,0,jt.length-1)),a=Math.floor(r),o=jt[a];if(this.originalColor=o.clone(),a!==jt.length-1){var s=r-a,l=jt[a+1];this.originalColor.lerp(l,s)}}if(i.color=new y.i(0).lerp(this.originalColor,D(n,0,1,.2,1)),this.target instanceof de&&this.mesh.position.set(this.target.pos.x,this.target.pos.y+this.target.droopY,1),ie(this.target)&&i.color.lerp(new y.i(0),1-this.target.energy/q.cellEnergyMax),null!=this.inventoryRenderer&&n>0&&this.inventoryRenderer.update(),this.target instanceof fe&&null!=this.audio){var u=this.target.didConvert?1:0;if(u!==this.lastAudioValueTracker&&u>0){this.audio.setBuffer(E);var c=this.target.pos.distanceToSquared(this.mito.world.player.pos),h=Math.min(1,1/(1+c/25))*this.target.sugarConverted*this.target.sugarConverted;this.audio.setVolume(h),this.audio.play()}this.lastAudioValueTracker=u}if(this.target instanceof me&&null!=this.audio){var d=this.target.waterTransferAmount;if(d!==this.lastAudioValueTracker){this.audio.setBuffer(A);var p=this.target.waterTransferAmount/(2+this.target.waterTransferAmount),v=this.target.pos.distanceToSquared(this.mito.world.player.pos),f=Math.min(1,1/(1+v/25))*p;this.audio.setVolume(f),null!=this.audio.source&&this.audio.stop(),this.audio.play()}this.lastAudioValueTracker=d}if(this.target.tilePairs instanceof Array){var m=this.target instanceof fe?16763150:new y.i("rgb(9, 12, 255)").getHex(),g=this.target.tilePairs;g.length!==this.pairsLines.length&&(this.pairsLines.forEach(function(t){return e.mesh.remove(t)}),this.pairsLines=g.map(function(t){var n=2*t.length()-.25,i=new y.E(t.x,t.y,0).normalize(),r=e.makeLine(i,i.clone().multiplyScalar(-n/2),n,m);return e.mesh.add(r),r}))}if(this.hasActiveNeighbors(this.target)){var w=this.target instanceof me?new y.i("rgb(9, 12, 255)").getHex():16777215,b=this.target.activeNeighbors;b.length!==this.pairsLines.length&&(this.pairsLines.forEach(function(t){return e.mesh.remove(t)}),this.pairsLines=b.map(function(t){var n=t.length()-.25,i=new y.E(t.x,t.y,0).normalize(),r=e.target instanceof me?e.makeLine(i,new y.E,n,w):new y.a(i,new y.E(0,0,5),n,w);return e.mesh.add(r),r}))}}},{key:"hasActiveNeighbors",value:function(e){return Array.isArray(e.activeNeighbors)}},{key:"makeLine",value:function(e,n,i,r){var a=new y.m(t.lineGeometry,new y.n({color:r}));if(a.position.copy(n),e.y>.99999)a.quaternion.set(0,0,0,1);else if(e.y<-.99999)a.quaternion.set(1,0,0,0);else{var o=new y.E(e.z,0,-e.x).normalize(),s=Math.acos(e.y);a.quaternion.setFromAxisAngle(o,s)}return a.scale.set(1,Math.max(0,i),1),a.position.z=.1,a.updateMatrix(),a.matrixAutoUpdate=!1,a}},{key:"destroy",value:function(){this.scene.remove(this.mesh),null!=this.inventoryRenderer&&this.inventoryRenderer.destroy()}}]),t}(tt);bt.lineGeometry=function(){var e=new y.g;return e.addAttribute("position",new y.l([0,0,0,0,1,0],3)),e}();var kt=We(function(){var e=new Map;return e.set(se,new y.r({side:y.j,depthWrite:!1})),e.set(le,new y.r({map:ht(8,11),side:y.j,color:new y.i("rgb(112, 89, 44)"),depthWrite:!1})),e.set(he,new y.r({map:ht(3.5,2.375),side:y.j})),e.set(ue,new y.r({map:ht(26,20),side:y.j,color:new y.i("rgb(63, 77, 84)")})),e.set(ce,new y.r({map:ht(8.5625,23.375),side:y.j,color:new y.i("rgb(128, 128, 128)")})),e.set(ve,new y.r({map:ht(6,31),side:y.j,color:new y.i(3190309)})),e.set(ge,e.get(ve)),e.set(fe,new y.r({map:ht(55/16,17.5),side:y.j})),e.set(me,new y.r({map:ht(59/16,327/16),side:y.j})),e.set(ye,new y.r({map:ut,side:y.j,transparent:!0})),e.set(we,new y.r({map:ht(Math.floor(11.5),Math.floor(9.5)),side:y.j})),e});var jt=[new y.i("hsl(67, 31%, 25%)"),new y.i("hsl(180, 31%, 76%)"),new y.i("hsl(213, 63%, 58%)")],Ot=function(e){function t(e,n,i){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(c.a)(t).call(this,e,n,i))).arrow=void 0,r.arrow=r.makeArrow(r.target.dir),r.mesh.add(r.arrow),r}return Object(h.a)(t,e),Object(l.a)(t,[{key:"makeArrow",value:function(e){var t=e.length()-.25,n=new y.E(e.x,e.y,0).normalize(),i=n.clone().multiplyScalar(-t/2);return new y.a(n,new y.E(i.x,i.y,1),t,16777215,.1,.1)}}]),t}(bt);var xt=function(e){function t(e,n,i){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(c.a)(t).call(this,e,n,i))).renderers=new Map,r.deleteDeadEntityRenderers=Object(et.a)(function(e){return e},function(e){var t=e.deleted,n=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var l=o.value,u=r.renderers.get(l);if(null==u)throw new Error("Couldn't find renderer for ".concat(l,"!"));u.destroy(),r.renderers.delete(l)}}catch(c){i=!0,a=c}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}}),n.add(yt.WaterParticles()),n.add(yt.SugarParticles()),r}return Object(h.a)(t,e),Object(l.a)(t,[{key:"getOrCreateRenderer",value:function(e){var t=this.renderers.get(e);if(null==t){var n=function(e,t,n){if(e instanceof xe)return new dt(e,t,n);if(e instanceof ge)return new Ot(e,t,n);if(e instanceof re)return new bt(e,t,n);throw new Error("Couldn't find renderer for ".concat(e))}(e,this.scene,this.mito);return this.renderers.set(e,n),n}return t}},{key:"update",value:function(){var e=this;this.deleteDeadEntityRenderers(this.target.getLastStepStats()),yt.startFrame(),this.target.entities().forEach(function(t){e.getOrCreateRenderer(t).update()}),yt.endFrame()}},{key:"destroy",value:function(){throw new Error("Method not implemented.")}}]),t}(tt),Et=function(e){function t(e,n,i,r){var a;return Object(s.a)(this,t),(a=Object(u.a)(this,Object(c.a)(t).call(this,e,n))).onWinLoss=r,a.world=void 0,a.scene=new y.z,a.camera=new y.t(0,0,0,0,-100,100),a.autoplace=void 0,a.tutorialRef=null,a.mouse=new y.D,a.hoveredTile=void 0,a.raycaster=new y.x,a.gameState="main",a.firstActionTakenYet=!1,a.audioListener=new y.d,a.keyMap=new Set,a.uiState={type:"main"},a.events={contextmenu:function(e){if("main"===a.uiState.type){var t=a.getTileAtScreenPosition(e.clientX,e.clientY);null!=t&&a.world.player.setAction({type:"deconstruct",position:t.pos})}return e.preventDefault(),!1},mousemove:function(e){a.mouse.x=e.clientX,a.mouse.y=e.clientY},click:function(e){a.handleClick(e.clientX,e.clientY)},keydown:function(e){a.firstActionTakenYet=!0;var t=e.key;a.keyMap.add(t),a.tryAction(t)},keyup:function(e){a.keyMap.delete(e.key)},wheel:function(e){var t=-(e.deltaX+e.deltaY)/125/20,n=a.camera.zoom*Math.pow(2,t);a.camera.zoom=n,a.camera.updateProjectionMatrix()}},a.tryAction=function(e){if("?"!==e){if("expanding"===a.uiState.type){if("Escape"===e)return void a.resetUIState();if(e in Oe&&(Oe[e]!==ye||null==a.world.fruit)){var t={type:"build",cellType:Oe[e],position:a.uiState.target};return a.world.player.setAction(t),void a.resetUIState()}if(be[e])return void a.resetUIState()}if("instructions"!==a.gameState){null!=a.autoplace&&"Escape"===e&&(a.autoplace=void 0);var n=be[e]||ke[e];null!=n?a.world.player.setAction(n):e in Oe&&(a.autoplace===Oe[e]||Oe[e]===ye&&null!=a.world.fruit?a.autoplace=void 0:a.autoplace=Oe[e])}else"Escape"===e&&(a.gameState="main")}else a.gameState="instructions"===a.gameState?"main":"instructions"},a.expandingTileHighlight=new y.q(new y.u(1,1),new y.r({color:"white",side:y.j,transparent:!0,opacity:.5})),a.worldRenderer=void 0,a.mapActions=function(e,t){if(null!=t){if("none"===t.type)return t;if(a.resetUIState(),"still"===t.type&&(a.autoplace===we||a.autoplace===ve))return{type:"build",cellType:a.autoplace,position:e.pos};if("move"!==t.type)return t;var n=a.world.tileAt(e.pos.x+t.dir.x,e.pos.y+t.dir.y),i=e.currentTile();if(null!=a.autoplace){if(a.autoplace===ge){if(null==t.dir)throw new Error("bad dir");return{type:"build-transport",cellType:ge,position:a.world.player.pos,dir:t.dir}}if(a.autoplace!==we||i instanceof we){if(e.verifyMove(t))return t;var r={type:"build",cellType:a.autoplace,position:e.pos.clone().add(t.dir)};return a.autoplace!==ve&&a.autoplace!==me&&(a.autoplace=void 0),r}return{type:"multiple",actions:[{type:"build",cellType:we,position:e.pos},t]}}return e.isBuildCandidate(n)?void(null!=a.tutorialRef&&a.tutorialRef.tutorialRef):t}},null==i.info.world&&(i.info.world=new Ae(i.info.environment)),a.world=i.info.world,a.camera.position.z=10,a.camera.lookAt(new y.E(0,0,0)),a.camera.position.x=a.world.player.pos.x,a.camera.position.y=a.world.player.pos.y,a.camera.zoom=1.5,a.resize(a.canvas.width,a.canvas.height),a.camera.add(a.audioListener),a.worldRenderer=new xt(a.world,a.scene,Object(R.a)(a)),a.world.step(),a.world.player.mapActions=a.mapActions,function(e){var t=0;function n(){3===++t&&(b.audio.currentTime=0,k.audio.currentTime=0,j.audio.currentTime=0,b.gain.connect(e.gain),k.gain.connect(e.gain),j.gain.connect(e.gain))}(b=F(e,"mito-base")).audio.oncanplaythrough=n,b.gain.gain.value=.5,(k=F(e,"mito-strings")).audio.oncanplaythrough=n,k.gain.gain.value=0,(j=F(e,"mito-drums")).audio.oncanplaythrough=n,j.gain.gain.value=0,(O=F(e,"footsteps")).gain.gain.value=0,O.gain.connect(e.gain),(x=F(e,"build")).gain.gain.value=0,x.gain.connect(e.gain);var i=new y.e;i.load("assets/audio/Blop-Mark_DiAngelo-79054334.mp3",function(e){E=e},function(e){e.loaded,e.total},function(e){}),i.load("assets/audio/suckwater.wav",function(e){A=e},function(e){e.loaded,e.total},function(e){})}(a.audioContext),a.updateAmbientAudio(),window.mito=Object(R.a)(a),a}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return i.createElement(i.Fragment,null,i.createElement(Ge,{autoplace:this.autoplace,mouseX:this.mouse.x,mouseY:this.mouse.y,uiState:this.uiState,isTutorialFinished:null==this.tutorialRef||this.tutorialRef.isFinished(),sugar:this.world.player.inventory.sugar,water:this.world.player.inventory.water,onTryActionKey:this.tryAction,world:this.world}),i.createElement(qe,{mito:this,state:this.gameState}),i.createElement(Ze,null),i.createElement(Qe,{mito:this}))}},{key:"enterUIStateExpanding",value:function(e){var t="main"===this.uiState.type?this.camera.zoom:this.uiState.originalZoom;this.uiState={type:"expanding",originalZoom:t,target:e}}},{key:"resetUIState",value:function(){"expanding"===this.uiState.type&&(this.camera.zoom=this.uiState.originalZoom,this.camera.updateProjectionMatrix(),this.uiState={type:"main"})}}]),Object(l.a)(t,[{key:"updateAmbientAudio",value:function(){var e=this.world.player.pos.y,t=D(e,this.world.height/2,this.world.height,0,.5),n=D(e,this.world.height/2,0,0,.5);j.gain.gain.value=Math.max(0,t),k.gain.gain.value=Math.max(0,n)}},{key:"logRenderInfo",value:function(){"Geometries in memory: ".concat(this.renderer.info.memory.geometries,"\nTextures in memory: ").concat(this.renderer.info.memory.textures,"\n# Render Calls: ").concat(this.renderer.info.render.calls,"\n# Render Lines: ").concat(this.renderer.info.render.lines,"\n# Render Points: ").concat(this.renderer.info.render.points,"\n# Render Tris: ").concat(this.renderer.info.render.triangles,"\n")}},{key:"perfDebug",value:function(){var e=0,t=0;this.scene.traverse(function(n){n.matrixAutoUpdate?e++:t++}),console.log("yes",e,"no",t);var n=new Map;this.scene.traverse(function(e){var t=n.get(e.name||e.constructor.name)||[];n.set(e.name||e.constructor.name,t),t.push(e)}),console.log(n)}},{key:"worldStep",value:function(){this.firstActionTakenYet&&(this.world.player.suckWater=!this.keyMap.has("j"),this.world.player.suckSugar=!this.keyMap.has("k"),this.world.step(),this.tutorialRef&&this.tutorialRef.setState({time:this.world.time}),"main"===this.gameState&&(this.gameState=this.world.checkWinLoss()||this.gameState,"win"!==this.gameState&&"lose"!==this.gameState||this.onWinLoss(this.gameState)),this.updateAmbientAudio())}},{key:"getCameraNormCoordinates",value:function(e,t){return new y.D(e/this.canvas.width*2-1,-t/this.canvas.height*2+1)}},{key:"getTileAtScreenPosition",value:function(e,t){var n=this.getCameraNormCoordinates(e,t);this.raycaster.setFromCamera(n,this.camera);var i=this.raycaster.ray.origin,r=i.x,a=i.y,o=Math.round(r),s=Math.round(a),l=this.world.tileAt(o,s);if(null!=l&&l.lightAmount()>0)return l}},{key:"animate",value:function(){var e=this.world;if(this.canvas.focus(),"main"===this.gameState){if(q.isRealtime){var t=this.keysToMovement(this.keyMap);t&&this.world.player.setAction(t),this.worldStep()}else null!=e.player.getAction()&&this.worldStep();this.worldRenderer.update()}"expanding"===this.uiState.type&&(this.world.player.isBuildCandidate(this.world.tileAt(this.uiState.target))||this.resetUIState());var n=this.getCameraNormCoordinates(this.mouse.x,this.mouse.y);if("main"===this.uiState.type){this.scene.remove(this.expandingTileHighlight);var i=new y.D(this.world.player.posFloat.x+n.x/2,this.world.player.posFloat.y-n.y/2);P(this.camera.position,i,.3)}else{this.scene.add(this.expandingTileHighlight),this.expandingTileHighlight.position.set(this.uiState.target.x,this.uiState.target.y,1);var r=new y.D(this.uiState.target.x,this.uiState.target.y);P(this.camera.position,r,.3)}this.renderer.render(this.scene,this.camera),this.hoveredTile=this.getTileAtScreenPosition(this.mouse.x,this.mouse.y)}},{key:"keysToMovement",value:function(e){var t=new y.D,n=!0,i=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var s=a.value;ke[s]&&t.add(ke[s].dir)}}catch(l){i=!0,r=l}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return 0===t.x&&0===t.y?null:{type:"move",dir:t}}},{key:"resize",value:function(e,t){var n=t/e;this.camera.left=-12/n,this.camera.right=12/n,this.camera.top=-12,this.camera.bottom=12,this.camera.updateProjectionMatrix()}},{key:"handleClick",value:function(e,n){this.firstActionTakenYet=!0;var i=this.getTileAtScreenPosition(e,n);if("expanding"===this.uiState.type&&(null!=i&&this.uiState.target.equals(i.pos)||this.resetUIState()),i)if(i.pos.equals(this.world.player.pos))this.world.player.setAction({type:"still"});else{var r,a=Fe(this.world.player.pos.x,this.world.player.pos.y,i.pos.x,i.pos.y);if(a)return this.world.player.isBuildCandidate(i)?void this.enterUIStateExpanding(i.pos):void this.world.player.setAction(a);r=this.autoplace&&-1!==t.expansionTiles.indexOf(this.autoplace)?Pe(Re(this.world,i.pos)):Pe(Te(this.world,i.pos,null!=this.autoplace)),this.world.player.setActions(r)}}}]),t}(w);Et.expansionTiles=[ve,me,we];var At=Et,St=n(12),Mt=n(26),Ct=n(80),Tt=n(13);n(71);function Rt(){var e=Object(St.a)(["\n  margin-left: auto;\n"]);return Rt=function(){return e},e}function Pt(){var e=Object(St.a)(["\n  cursor: pointer;\n  position: relative;\n  border-bottom: 1px solid black;\n  margin: 20px 0;\n  display: flex;\n"]);return Pt=function(){return e},e}function Dt(){var e=Object(St.a)(["\n  text-transform: uppercase;\n  font-size: 12px;\n  font-family: sans-serif;\n"]);return Dt=function(){return e},e}function Nt(){var e=Object(St.a)(["\n  cursor: pointer;\n  padding: 10px;\n  width: 100%;\n  background-color: darkgreen;\n  color: white;\n  font-size: 18px;\n"]);return Nt=function(){return e},e}function Ft(){var e=Object(St.a)(["\n  margin: 10px;\n  width: 320px;\n"]);return Ft=function(){return e},e}function Wt(){var e=Object(St.a)(["\n  position: absolute;\n  left: 20px;\n  align-self: center;\n  justify-self: top;\n  background: rgba(255, 255, 255, 0.9);\n  border-radius: 5px;\n  color: black;\n  animation: ",' 0.2s both;\n\n  &::before {\n    position: absolute;\n    top: 50%;\n    transform: translate(-100%, -50%);\n    left: 0;\n    content: "";\n    border: 20px solid transparent;\n    border-right-color: rgba(255, 255, 255, 0.9);\n  }\n']);return Wt=function(){return e},e}function Bt(){var e=Object(St.a)(["\n  from {\n    opacity: 0;\n    transform: translateX(-80px) scale(0.75);\n  }\n\n  to {\n    opacity: 1;\n    transform: translateX(0) scale(1);\n  }\n"]);return Bt=function(){return e},e}var Lt=Math.sqrt(3)/2,It=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).state={cameraState:{scale:48,dX:0,dY:0},pressedKeys:{}},n.canvas=null,n.rafId=void 0,n.handleCanvasRef=function(e){n.canvas=e,null!=e&&n.handleResize()},n.handleCanvasClick=function(e){if(null!=n.canvas)if(null!=n.state.highlightedTile)n.setState({highlightedTile:void 0});else{var t=function(e,t,n,i){var r=n.scale,a=n.dX,o=n.dY,s=t.width/2+a,l=t.height/2+o,u=i.nativeEvent,c=u.offsetX,h=u.offsetY,d=(c-s)/r/1.5,p=((h-l)/r-Lt*d)/(2*Lt),v=function(e,t,n){var i=Math.round(e),r=Math.round(t),a=Math.round(n),o=Math.abs(i-e),s=Math.abs(r-t),l=Math.abs(a-n);return o>s&&o>l?i=-r-a:s>l?r=-i-a:a=-i-r,{i:i,j:r,k:a}}(d,p,-(d+p));return e.tileAt(v.i,v.j)}(n.props.overWorld,n.canvas,n.state.cameraState,e);null!=t&&t.info.visible&&n.setState({highlightedTile:t})}},n.onPlayLevel=function(e){n.props.onPlayLevel(e)},n.handleKeyDown=function(e){if(!e.repeat){var t=Object(Y.a)({},n.state.pressedKeys,Object(Mt.a)({},e.code,!0));n.setState({pressedKeys:t})}},n.handleKeyUp=function(e){var t=Object(Y.a)({},n.state.pressedKeys);delete t[e.code],n.setState({pressedKeys:t})},n.handleResize=function(){null!=n.canvas&&(n.canvas.width=window.innerWidth,n.canvas.height=window.innerHeight,n.drawMap())},n.updateCamera=function(){var e=new y.D;for(var t in n.state.pressedKeys)"KeyW"===t||"ArrowUp"===t?e.y+=20:"KeyS"===t||"ArrowDown"===t?e.y-=20:"KeyA"===t||"ArrowLeft"===t?e.x+=20:"KeyD"!==t&&"ArrowRight"!==t||(e.x-=20);if(e.setLength(20),0!==e.x||0!==e.y){var i=n.state.cameraState;n.setState({cameraState:Object(Y.a)({},i,{dX:i.dX+e.x,dY:i.dY+e.y})})}n.rafId=requestAnimationFrame(n.updateCamera)},n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"drawMap",value:function(){if(null!=this.canvas){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height);var e=!0,t=!1,n=void 0;try{for(var i,r=this.props.overWorld[Symbol.iterator]();!(e=(i=r.next()).done);e=!0){var a=i.value;_t(this.canvas,this.state.cameraState,a)}}catch(o){t=!0,n=o}finally{try{e||null==r.return||r.return()}finally{if(t)throw n}}}}},{key:"componentDidMount",value:function(){document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp),window.addEventListener("resize",this.handleResize),this.rafId=requestAnimationFrame(this.updateCamera)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),window.removeEventListener("resize",this.handleResize),cancelAnimationFrame(this.rafId)}},{key:"componentDidUpdate",value:function(){this.drawMap()}},{key:"render",value:function(){return r.a.createElement("div",{className:"overworld-map-container"},r.a.createElement("canvas",{ref:this.handleCanvasRef,onClick:this.handleCanvasClick}),this.maybeRenderHighlightedTile())}},{key:"maybeRenderHighlightedTile",value:function(){if(null!=this.state.highlightedTile)return r.a.createElement(Ut,{camera:this.state.cameraState,tile:this.state.highlightedTile},r.a.createElement(Jt,{tile:this.state.highlightedTile,onClickPlay:this.onPlayLevel}))}}]),t}(r.a.Component),zt=Object(Tt.b)(Bt()),Yt=Tt.a.div(Wt(),zt);function Ut(e){var t=e.tile,n=e.camera,i=e.children,a=qt(t,n),o=Object(K.a)(a,2),s=o[0],l=o[1],u={zIndex:1,position:"absolute",left:s+.5*n.scale,top:l,display:"flex"};return r.a.createElement("div",{style:u},r.a.createElement(Yt,null,i))}function qt(e,t){var n=t.dX,i=t.dY,r=t.scale,a=e.cartesian,o=a.x,s=a.y;return[window.innerWidth/2+n+o*r,window.innerHeight/2+i+s*r]}function Vt(e,t,n,i){e.strokeStyle="rgb(112, 112, 112)",e.beginPath(),e.moveTo(t+i,n);for(var r=1;r<6;r++){var a=r/6*Math.PI*2;e.lineTo(t+Math.cos(a)*i,n+Math.sin(a)*i)}e.closePath(),e.fill(),e.stroke()}var Gt=Object(Ct.a)().domain([-1,0,1,5,6]).range(["rgb(0, 60, 255)","lightblue","yellow","orange"]);function _t(e,t,n){var i=t.scale,r=qt(n,t),a=Object(K.a)(r,2),o=a[0],s=a[1],l=e.getContext("2d");n.info.visible?(l.fillStyle=Gt(n.info.height),Vt(l,o,s,i),l.font="12px serif",l.textAlign="center",l.textBaseline="middle",l.fillStyle="#666",l.fillText(n.info.height+"",o,s,i)):(l.fillStyle="grey",Vt(l,o,s,i))}var Kt=Tt.a.div(Ft()),Ht=Tt.a.button(Nt()),Xt=Tt.a.div(Dt());function Jt(e){var t=e.tile,n=e.onClickPlay,i=-1===t.info.height||t.info.conquered?null:r.a.createElement(Ht,{onClick:function(){n(t)}},"Populate"),a=t.info.conquered?r.a.createElement("h1",null,"Populated"):-1===t.info.height?r.a.createElement("h1",null,"Deep Water"):r.a.createElement("h1",null,"Unexplored"),o=Object(Y.a)({},t.info);delete o.world;var s=-1===t.info.height?null:r.a.createElement($t,{shrunkElements:r.a.createElement(Xt,null,"Details")},r.a.createElement("pre",{style:{fontSize:"12px"}},JSON.stringify(o,null,4)));return r.a.createElement(Kt,null,a,s,i)}var Zt=Tt.a.div(Pt()),Qt=Tt.a.div(Rt());function $t(e){var t=e.children,n=e.shrunkElements,a=Object(i.useState)(!1),o=Object(K.a)(a,2),s=o[0],l=o[1];return r.a.createElement("div",null,r.a.createElement(Zt,{onClick:function(){l(!s)}},n,s?r.a.createElement(Qt,null,"\u25bc"):r.a.createElement(Qt,null,"\u25b6")),s?r.a.createElement("div",null,t):null)}var en=n(16),tn=n.n(en),nn=n(34),rn=n.n(nn),an=Math.sqrt(3)/2,on=function(){function e(t,n){Object(s.a)(this,e),this.i=t,this.j=n,this.neighbors=new Array(6),this.info={height:0,rainfall:"medium",soilType:"average",temperature:"temperate",wind:"low",conquered:!1,visible:!1}}return Object(l.a)(e,[{key:"k",get:function(){return-(this.i+this.j)}},{key:"magnitude",get:function(){return Math.abs(this.i)+Math.abs(this.j)+Math.abs(this.k)}},{key:"cartesian",get:function(){var e=this.i,t=this.j;return{x:1.5*e,y:2*an*t+an*e}}}]),e}(),sn=Symbol.iterator,ln=function(){function e(){Object(s.a)(this,e),this.tiles={}}return Object(l.a)(e,[{key:"hash",value:function(e,t){return"".concat(e,",").concat(t)}},{key:"get",value:function(e,t){return this.tiles[this.hash(e,t)]}},{key:"set",value:function(e,t,n){this.tiles[this.hash(e,t)]=n}},{key:"hookUpNeighbors",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,r=this[Symbol.iterator]();!(e=(i=r.next()).done);e=!0){var a=i.value,o=a.i,s=a.j;a.neighbors[0]=this.get(o+1,s),a.neighbors[1]=this.get(o,s+1),a.neighbors[2]=this.get(o-1,s+1),a.neighbors[3]=this.get(o-1,s),a.neighbors[4]=this.get(o,s-1),a.neighbors[5]=this.get(o+1,s-1)}}catch(l){t=!0,n=l}finally{try{e||null==r.return||r.return()}finally{if(t)throw n}}}},{key:sn,value:tn.a.mark(function e(){var t;return tn.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=tn.a.keys(this.tiles);case 1:if((e.t1=e.t0()).done){e.next=7;break}return t=e.t1.value,e.next=5,this.tiles[t];case 5:e.next=1;break;case 7:case"end":return e.stop()}},e,this)})}]),e}(),un=function(){function e(t){Object(s.a)(this,e),this.storage=t,t.hookUpNeighbors(),Array.from(t).filter(function(e){return 0===e.info.height}).sort(function(e,t){return e.magnitude-t.magnitude})[0].info.visible=!0}return Object(l.a)(e,null,[{key:"randomHeight",value:function(e,t){var n=e.cartesian,i=n.x,r=n.y,a=0;return a+=6*(t.noise3D(i/24,r/24,0)-.2),a+=6*t.noise3D(i/24,r/24,1.453),a+=1.5*t.noise3D(i/6,r/6,1.453),a+=1,(a-=.025*Math.abs(r*r))<0&&a>=-1&&(a=0),a=Math.round(Math.max(Math.min(a,6),-1))}},{key:"populateLevelInfo",value:function(t,n){var i=t.info;i.height=e.randomHeight(t,n),i.environment=i.height<2?Ke():i.height<4?Xe():He()}},{key:"generateFilledHex",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,n=new ln,i=new rn.a,r=-t;r<=t;r++)for(var a=-t;a<=t;a++){var o=-(r+a);if(!(Math.abs(o)>t)){var s=new on(r,a);e.populateLevelInfo(s,i),n.set(r,a,s)}}return new e(n)}},{key:"generateRectangle",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25,i=new ln,r=new rn.a,a=Math.max(t/2,n/2),o=-a;o<=a;o++)for(var s=-a;s<=a;s++){var l=-(o+s);if(!(Math.abs(l)>a)){var u=new on(o,s),c=u.cartesian,h=c.x,d=c.y;h<-t/2||h>t/2||d<-n/2||d>n/2||(e.populateLevelInfo(u,r),i.set(o,s,u))}}return new e(i)}}]),Object(l.a)(e,[{key:"tileAt",value:function(e,t){return this.storage.get(e,t)}},{key:Symbol.iterator,value:tn.a.mark(function e(){var t,n,i,r,a,o;return tn.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,n=!1,i=void 0,e.prev=3,r=this.storage[Symbol.iterator]();case 5:if(t=(a=r.next()).done){e.next=12;break}return o=a.value,e.next=9,o;case 9:t=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),n=!0,i=e.t0;case 18:e.prev=18,e.prev=19,t||null==r.return||r.return();case 21:if(e.prev=21,!n){e.next=24;break}throw i;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}},e,this,[[3,14,18,26],[19,,21,25]])})}]),e}(),cn=function(e){function t(){var e,n;Object(s.a)(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(c.a)(t)).call.apply(e,[this].concat(r)))).state={overWorld:un.generateRectangle(100,50)},n.handlePlayLevel=function(e){console.log(e.info),e.info.visible&&!e.info.conquered&&n.setState({activeLevel:e})},n.handleWinLoss=function(e){if("win"===e&&n.state.activeLevel){var t=n.state.activeLevel;t.info.conquered=!0;var i=!0,r=!1,a=void 0;try{for(var o,s=t.neighbors[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){o.value.info.visible=!0}}catch(l){r=!0,a=l}finally{try{i||null==s.return||s.return()}finally{if(r)throw a}}n.setState({activeLevel:void 0})}},n}return Object(h.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return r.a.createElement("div",{className:"App"},this.maybeRenderOverWorldMap(),this.maybeRenderLevel())}},{key:"maybeRenderOverWorldMap",value:function(){if(null==this.state.activeLevel)return r.a.createElement(It,{overWorld:this.state.overWorld,onPlayLevel:this.handlePlayLevel})}},{key:"maybeRenderLevel",value:function(){if(null!=this.state.activeLevel)return r.a.createElement(T,{sketchClass:At,otherArgs:[this.state.activeLevel,this.handleWinLoss]})}}]),t}(r.a.PureComponent);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(r.a.createElement(cn,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[48,1,2]]]);
//# sourceMappingURL=main.2d2077c5.chunk.js.map